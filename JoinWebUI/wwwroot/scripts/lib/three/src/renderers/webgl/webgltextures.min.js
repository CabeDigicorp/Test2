/**
 * Minified by jsDelivr using Terser v5.19.2.
 * Original file: /npm/three@0.170.0/src/renderers/webgl/WebGLTextures.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{LinearFilter,LinearMipmapLinearFilter,LinearMipmapNearestFilter,NearestFilter,NearestMipmapLinearFilter,NearestMipmapNearestFilter,RGBAFormat,DepthFormat,DepthStencilFormat,UnsignedIntType,FloatType,MirroredRepeatWrapping,ClampToEdgeWrapping,RepeatWrapping,UnsignedByteType,NoColorSpace,LinearSRGBColorSpace,NeverCompare,AlwaysCompare,LessCompare,LessEqualCompare,EqualCompare,GreaterEqualCompare,GreaterCompare,NotEqualCompare,SRGBTransfer,LinearTransfer,UnsignedShortType,UnsignedInt248Type}from"../../constants.js";import{createElementNS}from"../../utils.js";import{ColorManagement}from"../../math/ColorManagement.js";import{Vector2}from"../../math/Vector2.js";import{getByteLength}from"../../extras/TextureUtils.js";function WebGLTextures(e,t,r,a,i,n,E){const T=t.has("WEBGL_multisampled_render_to_texture")?t.get("WEBGL_multisampled_render_to_texture"):null,o="undefined"!=typeof navigator&&/OculusBrowser/g.test(navigator.userAgent),_=new Vector2,f=new WeakMap;let u;const l=new WeakMap;let s=!1;try{s="undefined"!=typeof OffscreenCanvas&&null!==new OffscreenCanvas(1,1).getContext("2d")}catch(e){}function R(e,t){return s?new OffscreenCanvas(e,t):createElementNS("canvas")}function d(e,t,r){let a=1;const i=H(e);if((i.width>r||i.height>r)&&(a=r/Math.max(i.width,i.height)),a<1){if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof VideoFrame&&e instanceof VideoFrame){const r=Math.floor(a*i.width),n=Math.floor(a*i.height);void 0===u&&(u=R(r,n));const E=t?R(r,n):u;E.width=r,E.height=n;return E.getContext("2d").drawImage(e,0,0,r,n),console.warn("THREE.WebGLRenderer: Texture has been resized from ("+i.width+"x"+i.height+") to ("+r+"x"+n+")."),E}return"data"in e&&console.warn("THREE.WebGLRenderer: Image in DataTexture is too big ("+i.width+"x"+i.height+")."),e}return e}function m(e){return e.generateMipmaps}function p(t){e.generateMipmap(t)}function g(t){return t.isWebGLCubeRenderTarget?e.TEXTURE_CUBE_MAP:t.isWebGL3DRenderTarget?e.TEXTURE_3D:t.isWebGLArrayRenderTarget||t.isCompressedArrayTexture?e.TEXTURE_2D_ARRAY:e.TEXTURE_2D}function h(r,a,i,n,E=!1){if(null!==r){if(void 0!==e[r])return e[r];console.warn("THREE.WebGLRenderer: Attempt to use non-existing WebGL internal format '"+r+"'")}let T=a;if(a===e.RED&&(i===e.FLOAT&&(T=e.R32F),i===e.HALF_FLOAT&&(T=e.R16F),i===e.UNSIGNED_BYTE&&(T=e.R8)),a===e.RED_INTEGER&&(i===e.UNSIGNED_BYTE&&(T=e.R8UI),i===e.UNSIGNED_SHORT&&(T=e.R16UI),i===e.UNSIGNED_INT&&(T=e.R32UI),i===e.BYTE&&(T=e.R8I),i===e.SHORT&&(T=e.R16I),i===e.INT&&(T=e.R32I)),a===e.RG&&(i===e.FLOAT&&(T=e.RG32F),i===e.HALF_FLOAT&&(T=e.RG16F),i===e.UNSIGNED_BYTE&&(T=e.RG8)),a===e.RG_INTEGER&&(i===e.UNSIGNED_BYTE&&(T=e.RG8UI),i===e.UNSIGNED_SHORT&&(T=e.RG16UI),i===e.UNSIGNED_INT&&(T=e.RG32UI),i===e.BYTE&&(T=e.RG8I),i===e.SHORT&&(T=e.RG16I),i===e.INT&&(T=e.RG32I)),a===e.RGB_INTEGER&&(i===e.UNSIGNED_BYTE&&(T=e.RGB8UI),i===e.UNSIGNED_SHORT&&(T=e.RGB16UI),i===e.UNSIGNED_INT&&(T=e.RGB32UI),i===e.BYTE&&(T=e.RGB8I),i===e.SHORT&&(T=e.RGB16I),i===e.INT&&(T=e.RGB32I)),a===e.RGBA_INTEGER&&(i===e.UNSIGNED_BYTE&&(T=e.RGBA8UI),i===e.UNSIGNED_SHORT&&(T=e.RGBA16UI),i===e.UNSIGNED_INT&&(T=e.RGBA32UI),i===e.BYTE&&(T=e.RGBA8I),i===e.SHORT&&(T=e.RGBA16I),i===e.INT&&(T=e.RGBA32I)),a===e.RGB&&i===e.UNSIGNED_INT_5_9_9_9_REV&&(T=e.RGB9_E5),a===e.RGBA){const t=E?LinearTransfer:ColorManagement.getTransfer(n);i===e.FLOAT&&(T=e.RGBA32F),i===e.HALF_FLOAT&&(T=e.RGBA16F),i===e.UNSIGNED_BYTE&&(T=t===SRGBTransfer?e.SRGB8_ALPHA8:e.RGBA8),i===e.UNSIGNED_SHORT_4_4_4_4&&(T=e.RGBA4),i===e.UNSIGNED_SHORT_5_5_5_1&&(T=e.RGB5_A1)}return T!==e.R16F&&T!==e.R32F&&T!==e.RG16F&&T!==e.RG32F&&T!==e.RGBA16F&&T!==e.RGBA32F||t.get("EXT_color_buffer_float"),T}function b(t,r){let a;return t?null===r||r===UnsignedIntType||r===UnsignedInt248Type?a=e.DEPTH24_STENCIL8:r===FloatType?a=e.DEPTH32F_STENCIL8:r===UnsignedShortType&&(a=e.DEPTH24_STENCIL8,console.warn("DepthTexture: 16 bit depth attachment is not supported with stencil. Using 24-bit attachment.")):null===r||r===UnsignedIntType||r===UnsignedInt248Type?a=e.DEPTH_COMPONENT24:r===FloatType?a=e.DEPTH_COMPONENT32F:r===UnsignedShortType&&(a=e.DEPTH_COMPONENT16),a}function F(e,t){return!0===m(e)||e.isFramebufferTexture&&e.minFilter!==NearestFilter&&e.minFilter!==LinearFilter?Math.log2(Math.max(t.width,t.height))+1:void 0!==e.mipmaps&&e.mipmaps.length>0?e.mipmaps.length:e.isCompressedTexture&&Array.isArray(e.image)?t.mipmaps.length:1}function c(e){const t=e.target;t.removeEventListener("dispose",c),function(e){const t=a.get(e);if(void 0===t.__webglInit)return;const r=e.source,i=l.get(r);if(i){const a=i[t.__cacheKey];a.usedTimes--,0===a.usedTimes&&U(e),0===Object.keys(i).length&&l.delete(r)}a.remove(e)}(t),t.isVideoTexture&&f.delete(t)}function A(t){const r=t.target;r.removeEventListener("dispose",A),function(t){const r=a.get(t);t.depthTexture&&(t.depthTexture.dispose(),a.remove(t.depthTexture));if(t.isWebGLCubeRenderTarget)for(let t=0;t<6;t++){if(Array.isArray(r.__webglFramebuffer[t]))for(let a=0;a<r.__webglFramebuffer[t].length;a++)e.deleteFramebuffer(r.__webglFramebuffer[t][a]);else e.deleteFramebuffer(r.__webglFramebuffer[t]);r.__webglDepthbuffer&&e.deleteRenderbuffer(r.__webglDepthbuffer[t])}else{if(Array.isArray(r.__webglFramebuffer))for(let t=0;t<r.__webglFramebuffer.length;t++)e.deleteFramebuffer(r.__webglFramebuffer[t]);else e.deleteFramebuffer(r.__webglFramebuffer);if(r.__webglDepthbuffer&&e.deleteRenderbuffer(r.__webglDepthbuffer),r.__webglMultisampledFramebuffer&&e.deleteFramebuffer(r.__webglMultisampledFramebuffer),r.__webglColorRenderbuffer)for(let t=0;t<r.__webglColorRenderbuffer.length;t++)r.__webglColorRenderbuffer[t]&&e.deleteRenderbuffer(r.__webglColorRenderbuffer[t]);r.__webglDepthRenderbuffer&&e.deleteRenderbuffer(r.__webglDepthRenderbuffer)}const i=t.textures;for(let t=0,r=i.length;t<r;t++){const r=a.get(i[t]);r.__webglTexture&&(e.deleteTexture(r.__webglTexture),E.memory.textures--),a.remove(i[t])}a.remove(t)}(r)}function U(t){const r=a.get(t);e.deleteTexture(r.__webglTexture);const i=t.source;delete l.get(i)[r.__cacheKey],E.memory.textures--}let D=0;function x(t,i){const n=a.get(t);if(t.isVideoTexture&&function(e){const t=E.render.frame;f.get(e)!==t&&(f.set(e,t),e.update())}(t),!1===t.isRenderTargetTexture&&t.version>0&&n.__version!==t.version){const e=t.image;if(null===e)console.warn("THREE.WebGLRenderer: Texture marked for update but no image data found.");else{if(!1!==e.complete)return void I(n,t,i);console.warn("THREE.WebGLRenderer: Texture marked for update but image is incomplete")}}r.bindTexture(e.TEXTURE_2D,n.__webglTexture,e.TEXTURE0+i)}const w={[RepeatWrapping]:e.REPEAT,[ClampToEdgeWrapping]:e.CLAMP_TO_EDGE,[MirroredRepeatWrapping]:e.MIRRORED_REPEAT},M={[NearestFilter]:e.NEAREST,[NearestMipmapNearestFilter]:e.NEAREST_MIPMAP_NEAREST,[NearestMipmapLinearFilter]:e.NEAREST_MIPMAP_LINEAR,[LinearFilter]:e.LINEAR,[LinearMipmapNearestFilter]:e.LINEAR_MIPMAP_NEAREST,[LinearMipmapLinearFilter]:e.LINEAR_MIPMAP_LINEAR},N={[NeverCompare]:e.NEVER,[AlwaysCompare]:e.ALWAYS,[LessCompare]:e.LESS,[LessEqualCompare]:e.LEQUAL,[EqualCompare]:e.EQUAL,[GreaterEqualCompare]:e.GEQUAL,[GreaterCompare]:e.GREATER,[NotEqualCompare]:e.NOTEQUAL};function B(r,n){if(n.type!==FloatType||!1!==t.has("OES_texture_float_linear")||n.magFilter!==LinearFilter&&n.magFilter!==LinearMipmapNearestFilter&&n.magFilter!==NearestMipmapLinearFilter&&n.magFilter!==LinearMipmapLinearFilter&&n.minFilter!==LinearFilter&&n.minFilter!==LinearMipmapNearestFilter&&n.minFilter!==NearestMipmapLinearFilter&&n.minFilter!==LinearMipmapLinearFilter||console.warn("THREE.WebGLRenderer: Unable to use linear filtering with floating point textures. OES_texture_float_linear not supported on this device."),e.texParameteri(r,e.TEXTURE_WRAP_S,w[n.wrapS]),e.texParameteri(r,e.TEXTURE_WRAP_T,w[n.wrapT]),r!==e.TEXTURE_3D&&r!==e.TEXTURE_2D_ARRAY||e.texParameteri(r,e.TEXTURE_WRAP_R,w[n.wrapR]),e.texParameteri(r,e.TEXTURE_MAG_FILTER,M[n.magFilter]),e.texParameteri(r,e.TEXTURE_MIN_FILTER,M[n.minFilter]),n.compareFunction&&(e.texParameteri(r,e.TEXTURE_COMPARE_MODE,e.COMPARE_REF_TO_TEXTURE),e.texParameteri(r,e.TEXTURE_COMPARE_FUNC,N[n.compareFunction])),!0===t.has("EXT_texture_filter_anisotropic")){if(n.magFilter===NearestFilter)return;if(n.minFilter!==NearestMipmapLinearFilter&&n.minFilter!==LinearMipmapLinearFilter)return;if(n.type===FloatType&&!1===t.has("OES_texture_float_linear"))return;if(n.anisotropy>1||a.get(n).__currentAnisotropy){const E=t.get("EXT_texture_filter_anisotropic");e.texParameterf(r,E.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(n.anisotropy,i.getMaxAnisotropy())),a.get(n).__currentAnisotropy=n.anisotropy}}}function C(t,r){let a=!1;void 0===t.__webglInit&&(t.__webglInit=!0,r.addEventListener("dispose",c));const i=r.source;let n=l.get(i);void 0===n&&(n={},l.set(i,n));const T=function(e){const t=[];return t.push(e.wrapS),t.push(e.wrapT),t.push(e.wrapR||0),t.push(e.magFilter),t.push(e.minFilter),t.push(e.anisotropy),t.push(e.internalFormat),t.push(e.format),t.push(e.type),t.push(e.generateMipmaps),t.push(e.premultiplyAlpha),t.push(e.flipY),t.push(e.unpackAlignment),t.push(e.colorSpace),t.join()}(r);if(T!==t.__cacheKey){void 0===n[T]&&(n[T]={texture:e.createTexture(),usedTimes:0},E.memory.textures++,a=!0),n[T].usedTimes++;const i=n[t.__cacheKey];void 0!==i&&(n[t.__cacheKey].usedTimes--,0===i.usedTimes&&U(r)),t.__cacheKey=T,t.__webglTexture=n[T].texture}return a}function I(t,E,T){let o=e.TEXTURE_2D;(E.isDataArrayTexture||E.isCompressedArrayTexture)&&(o=e.TEXTURE_2D_ARRAY),E.isData3DTexture&&(o=e.TEXTURE_3D);const _=C(t,E),f=E.source;r.bindTexture(o,t.__webglTexture,e.TEXTURE0+T);const u=a.get(f);if(f.version!==u.__version||!0===_){r.activeTexture(e.TEXTURE0+T);const t=ColorManagement.getPrimaries(ColorManagement.workingColorSpace),a=E.colorSpace===NoColorSpace?null:ColorManagement.getPrimaries(E.colorSpace),l=E.colorSpace===NoColorSpace||t===a?e.NONE:e.BROWSER_DEFAULT_WEBGL;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,E.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,E.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,E.unpackAlignment),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,l);let s=d(E.image,!1,i.maxTextureSize);s=v(E,s);const R=n.convert(E.format,E.colorSpace),g=n.convert(E.type);let c,A=h(E.internalFormat,R,g,E.colorSpace,E.isVideoTexture);B(o,E);const U=E.mipmaps,D=!0!==E.isVideoTexture,x=void 0===u.__version||!0===_,w=f.dataReady,M=F(E,s);if(E.isDepthTexture)A=b(E.format===DepthStencilFormat,E.type),x&&(D?r.texStorage2D(e.TEXTURE_2D,1,A,s.width,s.height):r.texImage2D(e.TEXTURE_2D,0,A,s.width,s.height,0,R,g,null));else if(E.isDataTexture)if(U.length>0){D&&x&&r.texStorage2D(e.TEXTURE_2D,M,A,U[0].width,U[0].height);for(let t=0,a=U.length;t<a;t++)c=U[t],D?w&&r.texSubImage2D(e.TEXTURE_2D,t,0,0,c.width,c.height,R,g,c.data):r.texImage2D(e.TEXTURE_2D,t,A,c.width,c.height,0,R,g,c.data);E.generateMipmaps=!1}else D?(x&&r.texStorage2D(e.TEXTURE_2D,M,A,s.width,s.height),w&&r.texSubImage2D(e.TEXTURE_2D,0,0,0,s.width,s.height,R,g,s.data)):r.texImage2D(e.TEXTURE_2D,0,A,s.width,s.height,0,R,g,s.data);else if(E.isCompressedTexture)if(E.isCompressedArrayTexture){D&&x&&r.texStorage3D(e.TEXTURE_2D_ARRAY,M,A,U[0].width,U[0].height,s.depth);for(let t=0,a=U.length;t<a;t++)if(c=U[t],E.format!==RGBAFormat)if(null!==R)if(D){if(w)if(E.layerUpdates.size>0){const a=getByteLength(c.width,c.height,E.format,E.type);for(const i of E.layerUpdates){const n=c.data.subarray(i*a/c.data.BYTES_PER_ELEMENT,(i+1)*a/c.data.BYTES_PER_ELEMENT);r.compressedTexSubImage3D(e.TEXTURE_2D_ARRAY,t,0,0,i,c.width,c.height,1,R,n)}E.clearLayerUpdates()}else r.compressedTexSubImage3D(e.TEXTURE_2D_ARRAY,t,0,0,0,c.width,c.height,s.depth,R,c.data)}else r.compressedTexImage3D(e.TEXTURE_2D_ARRAY,t,A,c.width,c.height,s.depth,0,c.data,0,0);else console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()");else D?w&&r.texSubImage3D(e.TEXTURE_2D_ARRAY,t,0,0,0,c.width,c.height,s.depth,R,g,c.data):r.texImage3D(e.TEXTURE_2D_ARRAY,t,A,c.width,c.height,s.depth,0,R,g,c.data)}else{D&&x&&r.texStorage2D(e.TEXTURE_2D,M,A,U[0].width,U[0].height);for(let t=0,a=U.length;t<a;t++)c=U[t],E.format!==RGBAFormat?null!==R?D?w&&r.compressedTexSubImage2D(e.TEXTURE_2D,t,0,0,c.width,c.height,R,c.data):r.compressedTexImage2D(e.TEXTURE_2D,t,A,c.width,c.height,0,c.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):D?w&&r.texSubImage2D(e.TEXTURE_2D,t,0,0,c.width,c.height,R,g,c.data):r.texImage2D(e.TEXTURE_2D,t,A,c.width,c.height,0,R,g,c.data)}else if(E.isDataArrayTexture)if(D){if(x&&r.texStorage3D(e.TEXTURE_2D_ARRAY,M,A,s.width,s.height,s.depth),w)if(E.layerUpdates.size>0){const t=getByteLength(s.width,s.height,E.format,E.type);for(const a of E.layerUpdates){const i=s.data.subarray(a*t/s.data.BYTES_PER_ELEMENT,(a+1)*t/s.data.BYTES_PER_ELEMENT);r.texSubImage3D(e.TEXTURE_2D_ARRAY,0,0,0,a,s.width,s.height,1,R,g,i)}E.clearLayerUpdates()}else r.texSubImage3D(e.TEXTURE_2D_ARRAY,0,0,0,0,s.width,s.height,s.depth,R,g,s.data)}else r.texImage3D(e.TEXTURE_2D_ARRAY,0,A,s.width,s.height,s.depth,0,R,g,s.data);else if(E.isData3DTexture)D?(x&&r.texStorage3D(e.TEXTURE_3D,M,A,s.width,s.height,s.depth),w&&r.texSubImage3D(e.TEXTURE_3D,0,0,0,0,s.width,s.height,s.depth,R,g,s.data)):r.texImage3D(e.TEXTURE_3D,0,A,s.width,s.height,s.depth,0,R,g,s.data);else if(E.isFramebufferTexture){if(x)if(D)r.texStorage2D(e.TEXTURE_2D,M,A,s.width,s.height);else{let t=s.width,a=s.height;for(let i=0;i<M;i++)r.texImage2D(e.TEXTURE_2D,i,A,t,a,0,R,g,null),t>>=1,a>>=1}}else if(U.length>0){if(D&&x){const t=H(U[0]);r.texStorage2D(e.TEXTURE_2D,M,A,t.width,t.height)}for(let t=0,a=U.length;t<a;t++)c=U[t],D?w&&r.texSubImage2D(e.TEXTURE_2D,t,0,0,R,g,c):r.texImage2D(e.TEXTURE_2D,t,A,R,g,c);E.generateMipmaps=!1}else if(D){if(x){const t=H(s);r.texStorage2D(e.TEXTURE_2D,M,A,t.width,t.height)}w&&r.texSubImage2D(e.TEXTURE_2D,0,0,0,R,g,s)}else r.texImage2D(e.TEXTURE_2D,0,A,R,g,s);m(E)&&p(o),u.__version=f.version,E.onUpdate&&E.onUpdate(E)}t.__version=E.version}function S(t,i,E,o,_,f){const u=n.convert(E.format,E.colorSpace),l=n.convert(E.type),s=h(E.internalFormat,u,l,E.colorSpace),R=a.get(i),d=a.get(E);if(d.__renderTarget=i,!R.__hasExternalTextures){const t=Math.max(1,i.width>>f),a=Math.max(1,i.height>>f);_===e.TEXTURE_3D||_===e.TEXTURE_2D_ARRAY?r.texImage3D(_,f,s,t,a,i.depth,0,u,l,null):r.texImage2D(_,f,s,t,a,0,u,l,null)}r.bindFramebuffer(e.FRAMEBUFFER,t),O(i)?T.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,o,_,d.__webglTexture,0,y(i)):(_===e.TEXTURE_2D||_>=e.TEXTURE_CUBE_MAP_POSITIVE_X&&_<=e.TEXTURE_CUBE_MAP_NEGATIVE_Z)&&e.framebufferTexture2D(e.FRAMEBUFFER,o,_,d.__webglTexture,f),r.bindFramebuffer(e.FRAMEBUFFER,null)}function L(t,r,a){if(e.bindRenderbuffer(e.RENDERBUFFER,t),r.depthBuffer){const i=r.depthTexture,n=i&&i.isDepthTexture?i.type:null,E=b(r.stencilBuffer,n),o=r.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,_=y(r);O(r)?T.renderbufferStorageMultisampleEXT(e.RENDERBUFFER,_,E,r.width,r.height):a?e.renderbufferStorageMultisample(e.RENDERBUFFER,_,E,r.width,r.height):e.renderbufferStorage(e.RENDERBUFFER,E,r.width,r.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,o,e.RENDERBUFFER,t)}else{const t=r.textures;for(let i=0;i<t.length;i++){const E=t[i],o=n.convert(E.format,E.colorSpace),_=n.convert(E.type),f=h(E.internalFormat,o,_,E.colorSpace),u=y(r);a&&!1===O(r)?e.renderbufferStorageMultisample(e.RENDERBUFFER,u,f,r.width,r.height):O(r)?T.renderbufferStorageMultisampleEXT(e.RENDERBUFFER,u,f,r.width,r.height):e.renderbufferStorage(e.RENDERBUFFER,f,r.width,r.height)}}e.bindRenderbuffer(e.RENDERBUFFER,null)}function X(t){const i=a.get(t),n=!0===t.isWebGLCubeRenderTarget;if(i.__boundDepthTexture!==t.depthTexture){const e=t.depthTexture;if(i.__depthDisposeCallback&&i.__depthDisposeCallback(),e){const t=()=>{delete i.__boundDepthTexture,delete i.__depthDisposeCallback,e.removeEventListener("dispose",t)};e.addEventListener("dispose",t),i.__depthDisposeCallback=t}i.__boundDepthTexture=e}if(t.depthTexture&&!i.__autoAllocateDepthBuffer){if(n)throw new Error("target.depthTexture not supported in Cube render targets");!function(t,i){if(i&&i.isWebGLCubeRenderTarget)throw new Error("Depth Texture with cube render targets is not supported");if(r.bindFramebuffer(e.FRAMEBUFFER,t),!i.depthTexture||!i.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");const n=a.get(i.depthTexture);n.__renderTarget=i,n.__webglTexture&&i.depthTexture.image.width===i.width&&i.depthTexture.image.height===i.height||(i.depthTexture.image.width=i.width,i.depthTexture.image.height=i.height,i.depthTexture.needsUpdate=!0),x(i.depthTexture,0);const E=n.__webglTexture,o=y(i);if(i.depthTexture.format===DepthFormat)O(i)?T.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,E,0,o):e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,E,0);else{if(i.depthTexture.format!==DepthStencilFormat)throw new Error("Unknown depthTexture format");O(i)?T.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.TEXTURE_2D,E,0,o):e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.TEXTURE_2D,E,0)}}(i.__webglFramebuffer,t)}else if(n){i.__webglDepthbuffer=[];for(let a=0;a<6;a++)if(r.bindFramebuffer(e.FRAMEBUFFER,i.__webglFramebuffer[a]),void 0===i.__webglDepthbuffer[a])i.__webglDepthbuffer[a]=e.createRenderbuffer(),L(i.__webglDepthbuffer[a],t,!1);else{const r=t.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,n=i.__webglDepthbuffer[a];e.bindRenderbuffer(e.RENDERBUFFER,n),e.framebufferRenderbuffer(e.FRAMEBUFFER,r,e.RENDERBUFFER,n)}}else if(r.bindFramebuffer(e.FRAMEBUFFER,i.__webglFramebuffer),void 0===i.__webglDepthbuffer)i.__webglDepthbuffer=e.createRenderbuffer(),L(i.__webglDepthbuffer,t,!1);else{const r=t.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,a=i.__webglDepthbuffer;e.bindRenderbuffer(e.RENDERBUFFER,a),e.framebufferRenderbuffer(e.FRAMEBUFFER,r,e.RENDERBUFFER,a)}r.bindFramebuffer(e.FRAMEBUFFER,null)}const G=[],P=[];function y(e){return Math.min(i.maxSamples,e.samples)}function O(e){const r=a.get(e);return e.samples>0&&!0===t.has("WEBGL_multisampled_render_to_texture")&&!1!==r.__useRenderToTexture}function v(e,t){const r=e.colorSpace,a=e.format,i=e.type;return!0===e.isCompressedTexture||!0===e.isVideoTexture||r!==LinearSRGBColorSpace&&r!==NoColorSpace&&(ColorManagement.getTransfer(r)===SRGBTransfer?a===RGBAFormat&&i===UnsignedByteType||console.warn("THREE.WebGLTextures: sRGB encoded textures have to use RGBAFormat and UnsignedByteType."):console.error("THREE.WebGLTextures: Unsupported texture color space:",r)),t}function H(e){return"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement?(_.width=e.naturalWidth||e.width,_.height=e.naturalHeight||e.height):"undefined"!=typeof VideoFrame&&e instanceof VideoFrame?(_.width=e.displayWidth,_.height=e.displayHeight):(_.width=e.width,_.height=e.height),_}this.allocateTextureUnit=function(){const e=D;return e>=i.maxTextures&&console.warn("THREE.WebGLTextures: Trying to use "+e+" texture units while this GPU supports only "+i.maxTextures),D+=1,e},this.resetTextureUnits=function(){D=0},this.setTexture2D=x,this.setTexture2DArray=function(t,i){const n=a.get(t);t.version>0&&n.__version!==t.version?I(n,t,i):r.bindTexture(e.TEXTURE_2D_ARRAY,n.__webglTexture,e.TEXTURE0+i)},this.setTexture3D=function(t,i){const n=a.get(t);t.version>0&&n.__version!==t.version?I(n,t,i):r.bindTexture(e.TEXTURE_3D,n.__webglTexture,e.TEXTURE0+i)},this.setTextureCube=function(t,E){const T=a.get(t);t.version>0&&T.__version!==t.version?function(t,E,T){if(6!==E.image.length)return;const o=C(t,E),_=E.source;r.bindTexture(e.TEXTURE_CUBE_MAP,t.__webglTexture,e.TEXTURE0+T);const f=a.get(_);if(_.version!==f.__version||!0===o){r.activeTexture(e.TEXTURE0+T);const t=ColorManagement.getPrimaries(ColorManagement.workingColorSpace),a=E.colorSpace===NoColorSpace?null:ColorManagement.getPrimaries(E.colorSpace),u=E.colorSpace===NoColorSpace||t===a?e.NONE:e.BROWSER_DEFAULT_WEBGL;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,E.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,E.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,E.unpackAlignment),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,u);const l=E.isCompressedTexture||E.image[0].isCompressedTexture,s=E.image[0]&&E.image[0].isDataTexture,R=[];for(let e=0;e<6;e++)R[e]=l||s?s?E.image[e].image:E.image[e]:d(E.image[e],!0,i.maxCubemapSize),R[e]=v(E,R[e]);const g=R[0],b=n.convert(E.format,E.colorSpace),c=n.convert(E.type),A=h(E.internalFormat,b,c,E.colorSpace),U=!0!==E.isVideoTexture,D=void 0===f.__version||!0===o,x=_.dataReady;let w,M=F(E,g);if(B(e.TEXTURE_CUBE_MAP,E),l){U&&D&&r.texStorage2D(e.TEXTURE_CUBE_MAP,M,A,g.width,g.height);for(let t=0;t<6;t++){w=R[t].mipmaps;for(let a=0;a<w.length;a++){const i=w[a];E.format!==RGBAFormat?null!==b?U?x&&r.compressedTexSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,a,0,0,i.width,i.height,b,i.data):r.compressedTexImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,a,A,i.width,i.height,0,i.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):U?x&&r.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,a,0,0,i.width,i.height,b,c,i.data):r.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,a,A,i.width,i.height,0,b,c,i.data)}}}else{if(w=E.mipmaps,U&&D){w.length>0&&M++;const t=H(R[0]);r.texStorage2D(e.TEXTURE_CUBE_MAP,M,A,t.width,t.height)}for(let t=0;t<6;t++)if(s){U?x&&r.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,0,0,R[t].width,R[t].height,b,c,R[t].data):r.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,A,R[t].width,R[t].height,0,b,c,R[t].data);for(let a=0;a<w.length;a++){const i=w[a].image[t].image;U?x&&r.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,a+1,0,0,i.width,i.height,b,c,i.data):r.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,a+1,A,i.width,i.height,0,b,c,i.data)}}else{U?x&&r.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,0,0,b,c,R[t]):r.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,A,b,c,R[t]);for(let a=0;a<w.length;a++){const i=w[a];U?x&&r.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,a+1,0,0,b,c,i.image[t]):r.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,a+1,A,b,c,i.image[t])}}}m(E)&&p(e.TEXTURE_CUBE_MAP),f.__version=_.version,E.onUpdate&&E.onUpdate(E)}t.__version=E.version}(T,t,E):r.bindTexture(e.TEXTURE_CUBE_MAP,T.__webglTexture,e.TEXTURE0+E)},this.rebindTextures=function(t,r,i){const n=a.get(t);void 0!==r&&S(n.__webglFramebuffer,t,t.texture,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,0),void 0!==i&&X(t)},this.setupRenderTarget=function(t){const i=t.texture,T=a.get(t),o=a.get(i);t.addEventListener("dispose",A);const _=t.textures,f=!0===t.isWebGLCubeRenderTarget,u=_.length>1;if(u||(void 0===o.__webglTexture&&(o.__webglTexture=e.createTexture()),o.__version=i.version,E.memory.textures++),f){T.__webglFramebuffer=[];for(let t=0;t<6;t++)if(i.mipmaps&&i.mipmaps.length>0){T.__webglFramebuffer[t]=[];for(let r=0;r<i.mipmaps.length;r++)T.__webglFramebuffer[t][r]=e.createFramebuffer()}else T.__webglFramebuffer[t]=e.createFramebuffer()}else{if(i.mipmaps&&i.mipmaps.length>0){T.__webglFramebuffer=[];for(let t=0;t<i.mipmaps.length;t++)T.__webglFramebuffer[t]=e.createFramebuffer()}else T.__webglFramebuffer=e.createFramebuffer();if(u)for(let t=0,r=_.length;t<r;t++){const r=a.get(_[t]);void 0===r.__webglTexture&&(r.__webglTexture=e.createTexture(),E.memory.textures++)}if(t.samples>0&&!1===O(t)){T.__webglMultisampledFramebuffer=e.createFramebuffer(),T.__webglColorRenderbuffer=[],r.bindFramebuffer(e.FRAMEBUFFER,T.__webglMultisampledFramebuffer);for(let r=0;r<_.length;r++){const a=_[r];T.__webglColorRenderbuffer[r]=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,T.__webglColorRenderbuffer[r]);const i=n.convert(a.format,a.colorSpace),E=n.convert(a.type),o=h(a.internalFormat,i,E,a.colorSpace,!0===t.isXRRenderTarget),f=y(t);e.renderbufferStorageMultisample(e.RENDERBUFFER,f,o,t.width,t.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+r,e.RENDERBUFFER,T.__webglColorRenderbuffer[r])}e.bindRenderbuffer(e.RENDERBUFFER,null),t.depthBuffer&&(T.__webglDepthRenderbuffer=e.createRenderbuffer(),L(T.__webglDepthRenderbuffer,t,!0)),r.bindFramebuffer(e.FRAMEBUFFER,null)}}if(f){r.bindTexture(e.TEXTURE_CUBE_MAP,o.__webglTexture),B(e.TEXTURE_CUBE_MAP,i);for(let r=0;r<6;r++)if(i.mipmaps&&i.mipmaps.length>0)for(let a=0;a<i.mipmaps.length;a++)S(T.__webglFramebuffer[r][a],t,i,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+r,a);else S(T.__webglFramebuffer[r],t,i,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+r,0);m(i)&&p(e.TEXTURE_CUBE_MAP),r.unbindTexture()}else if(u){for(let i=0,n=_.length;i<n;i++){const n=_[i],E=a.get(n);r.bindTexture(e.TEXTURE_2D,E.__webglTexture),B(e.TEXTURE_2D,n),S(T.__webglFramebuffer,t,n,e.COLOR_ATTACHMENT0+i,e.TEXTURE_2D,0),m(n)&&p(e.TEXTURE_2D)}r.unbindTexture()}else{let a=e.TEXTURE_2D;if((t.isWebGL3DRenderTarget||t.isWebGLArrayRenderTarget)&&(a=t.isWebGL3DRenderTarget?e.TEXTURE_3D:e.TEXTURE_2D_ARRAY),r.bindTexture(a,o.__webglTexture),B(a,i),i.mipmaps&&i.mipmaps.length>0)for(let r=0;r<i.mipmaps.length;r++)S(T.__webglFramebuffer[r],t,i,e.COLOR_ATTACHMENT0,a,r);else S(T.__webglFramebuffer,t,i,e.COLOR_ATTACHMENT0,a,0);m(i)&&p(a),r.unbindTexture()}t.depthBuffer&&X(t)},this.updateRenderTargetMipmap=function(e){const t=e.textures;for(let i=0,n=t.length;i<n;i++){const n=t[i];if(m(n)){const t=g(e),i=a.get(n).__webglTexture;r.bindTexture(t,i),p(t),r.unbindTexture()}}},this.updateMultisampleRenderTarget=function(t){if(t.samples>0)if(!1===O(t)){const i=t.textures,n=t.width,E=t.height;let T=e.COLOR_BUFFER_BIT;const _=t.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,f=a.get(t),u=i.length>1;if(u)for(let t=0;t<i.length;t++)r.bindFramebuffer(e.FRAMEBUFFER,f.__webglMultisampledFramebuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.RENDERBUFFER,null),r.bindFramebuffer(e.FRAMEBUFFER,f.__webglFramebuffer),e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.TEXTURE_2D,null,0);r.bindFramebuffer(e.READ_FRAMEBUFFER,f.__webglMultisampledFramebuffer),r.bindFramebuffer(e.DRAW_FRAMEBUFFER,f.__webglFramebuffer);for(let r=0;r<i.length;r++){if(t.resolveDepthBuffer&&(t.depthBuffer&&(T|=e.DEPTH_BUFFER_BIT),t.stencilBuffer&&t.resolveStencilBuffer&&(T|=e.STENCIL_BUFFER_BIT)),u){e.framebufferRenderbuffer(e.READ_FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.RENDERBUFFER,f.__webglColorRenderbuffer[r]);const t=a.get(i[r]).__webglTexture;e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,0)}e.blitFramebuffer(0,0,n,E,0,0,n,E,T,e.NEAREST),!0===o&&(G.length=0,P.length=0,G.push(e.COLOR_ATTACHMENT0+r),t.depthBuffer&&!1===t.resolveDepthBuffer&&(G.push(_),P.push(_),e.invalidateFramebuffer(e.DRAW_FRAMEBUFFER,P)),e.invalidateFramebuffer(e.READ_FRAMEBUFFER,G))}if(r.bindFramebuffer(e.READ_FRAMEBUFFER,null),r.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),u)for(let t=0;t<i.length;t++){r.bindFramebuffer(e.FRAMEBUFFER,f.__webglMultisampledFramebuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.RENDERBUFFER,f.__webglColorRenderbuffer[t]);const n=a.get(i[t]).__webglTexture;r.bindFramebuffer(e.FRAMEBUFFER,f.__webglFramebuffer),e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.TEXTURE_2D,n,0)}r.bindFramebuffer(e.DRAW_FRAMEBUFFER,f.__webglMultisampledFramebuffer)}else if(t.depthBuffer&&!1===t.resolveDepthBuffer&&o){const r=t.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT;e.invalidateFramebuffer(e.DRAW_FRAMEBUFFER,[r])}},this.setupDepthRenderbuffer=X,this.setupFrameBufferTexture=S,this.useMultisampledRTT=O}export{WebGLTextures};
//# sourceMappingURL=/sm/16acdaaf53acd5174ed6c9087fbe150f3cf2db1bf03980b02700ecc41baa53e7.map