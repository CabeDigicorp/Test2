/**
 * Minified by jsDelivr using Terser v5.19.2.
 * Original file: /npm/three@0.170.0/src/renderers/WebGLRenderer.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{REVISION,BackSide,FrontSide,DoubleSide,HalfFloatType,UnsignedByteType,NoToneMapping,LinearMipmapLinearFilter,SRGBColorSpace,LinearSRGBColorSpace,RGBAIntegerFormat,RGIntegerFormat,RedIntegerFormat,UnsignedIntType,UnsignedShortType,UnsignedInt248Type,UnsignedShort4444Type,UnsignedShort5551Type,WebGLCoordinateSystem}from"../constants.js";import{Color}from"../math/Color.js";import{Frustum}from"../math/Frustum.js";import{Matrix4}from"../math/Matrix4.js";import{Vector3}from"../math/Vector3.js";import{Vector4}from"../math/Vector4.js";import{WebGLAnimation}from"./webgl/WebGLAnimation.js";import{WebGLAttributes}from"./webgl/WebGLAttributes.js";import{WebGLBackground}from"./webgl/WebGLBackground.js";import{WebGLBindingStates}from"./webgl/WebGLBindingStates.js";import{WebGLBufferRenderer}from"./webgl/WebGLBufferRenderer.js";import{WebGLCapabilities}from"./webgl/WebGLCapabilities.js";import{WebGLClipping}from"./webgl/WebGLClipping.js";import{WebGLCubeMaps}from"./webgl/WebGLCubeMaps.js";import{WebGLCubeUVMaps}from"./webgl/WebGLCubeUVMaps.js";import{WebGLExtensions}from"./webgl/WebGLExtensions.js";import{WebGLGeometries}from"./webgl/WebGLGeometries.js";import{WebGLIndexedBufferRenderer}from"./webgl/WebGLIndexedBufferRenderer.js";import{WebGLInfo}from"./webgl/WebGLInfo.js";import{WebGLMorphtargets}from"./webgl/WebGLMorphtargets.js";import{WebGLObjects}from"./webgl/WebGLObjects.js";import{WebGLPrograms}from"./webgl/WebGLPrograms.js";import{WebGLProperties}from"./webgl/WebGLProperties.js";import{WebGLRenderLists}from"./webgl/WebGLRenderLists.js";import{WebGLRenderStates}from"./webgl/WebGLRenderStates.js";import{WebGLRenderTarget}from"./WebGLRenderTarget.js";import{WebGLShadowMap}from"./webgl/WebGLShadowMap.js";import{WebGLState}from"./webgl/WebGLState.js";import{WebGLTextures}from"./webgl/WebGLTextures.js";import{WebGLUniforms}from"./webgl/WebGLUniforms.js";import{WebGLUtils}from"./webgl/WebGLUtils.js";import{WebXRManager}from"./webxr/WebXRManager.js";import{WebGLMaterials}from"./webgl/WebGLMaterials.js";import{WebGLUniformsGroups}from"./webgl/WebGLUniformsGroups.js";import{createCanvasElement,probeAsync,toNormalizedProjectionMatrix,toReversedProjectionMatrix,warnOnce}from"../utils.js";import{ColorManagement}from"../math/ColorManagement.js";class WebGLRenderer{constructor(e={}){const{canvas:t=createCanvasElement(),context:r=null,depth:n=!0,stencil:i=!1,alpha:s=!1,antialias:o=!1,premultipliedAlpha:a=!0,preserveDrawingBuffer:l=!1,powerPreference:u="default",failIfMajorPerformanceCaveat:d=!1,reverseDepthBuffer:p=!1}=e;let c;if(this.isWebGLRenderer=!0,null!==r){if("undefined"!=typeof WebGLRenderingContext&&r instanceof WebGLRenderingContext)throw new Error("THREE.WebGLRenderer: WebGL 1 is not supported since r163.");c=r.getContextAttributes().alpha}else c=s;const g=new Uint32Array(4),h=new Int32Array(4);let f=null,m=null;const b=[],T=[];this.domElement=t,this.debug={checkShaderErrors:!0,onShaderError:null},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this._outputColorSpace=SRGBColorSpace,this.toneMapping=NoToneMapping,this.toneMappingExposure=1;const x=this;let L=!1,M=0,w=0,S=null,R=-1,_=null;const E=new Vector4,C=new Vector4;let v=null;const G=new Color(0);let W=0,A=t.width,y=t.height,P=1,U=null,D=null;const F=new Vector4(0,0,A,y),B=new Vector4(0,0,A,y);let I=!1;const j=new Frustum;let O=!1,V=!1;const N=new Matrix4,H=new Matrix4,K=new Vector3,k=new Vector4,z={background:null,fog:null,environment:null,overrideMaterial:null,isScene:!0};let X=!1;function q(){return null===S?P:1}let Y,$,J,Q,Z,ee,te,re,ne,ie,se,oe,ae,le,ue,de,pe,ce,ge,he,fe,me,be,Te,xe=r;function Le(e,r){return t.getContext(e,r)}try{const e={alpha:!0,depth:n,stencil:i,antialias:o,premultipliedAlpha:a,preserveDrawingBuffer:l,powerPreference:u,failIfMajorPerformanceCaveat:d};if("setAttribute"in t&&t.setAttribute("data-engine",`three.js r${REVISION}`),t.addEventListener("webglcontextlost",Se,!1),t.addEventListener("webglcontextrestored",Re,!1),t.addEventListener("webglcontextcreationerror",_e,!1),null===xe){const t="webgl2";if(xe=Le(t,e),null===xe)throw Le(t)?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.")}}catch(e){throw console.error("THREE.WebGLRenderer: "+e.message),e}function Me(){Y=new WebGLExtensions(xe),Y.init(),me=new WebGLUtils(xe,Y),$=new WebGLCapabilities(xe,Y,e,me),J=new WebGLState(xe,Y),$.reverseDepthBuffer&&p&&J.buffers.depth.setReversed(!0),Q=new WebGLInfo(xe),Z=new WebGLProperties,ee=new WebGLTextures(xe,Y,J,Z,$,me,Q),te=new WebGLCubeMaps(x),re=new WebGLCubeUVMaps(x),ne=new WebGLAttributes(xe),be=new WebGLBindingStates(xe,ne),ie=new WebGLGeometries(xe,ne,Q,be),se=new WebGLObjects(xe,ie,ne,Q),ge=new WebGLMorphtargets(xe,$,ee),de=new WebGLClipping(Z),oe=new WebGLPrograms(x,te,re,Y,$,be,de),ae=new WebGLMaterials(x,Z),le=new WebGLRenderLists,ue=new WebGLRenderStates(Y),ce=new WebGLBackground(x,te,re,J,se,c,a),pe=new WebGLShadowMap(x,se,$),Te=new WebGLUniformsGroups(xe,Q,$,J),he=new WebGLBufferRenderer(xe,Y,Q),fe=new WebGLIndexedBufferRenderer(xe,Y,Q),Q.programs=oe.programs,x.capabilities=$,x.extensions=Y,x.properties=Z,x.renderLists=le,x.shadowMap=pe,x.state=J,x.info=Q}Me();const we=new WebXRManager(x,xe);function Se(e){e.preventDefault(),console.log("THREE.WebGLRenderer: Context Lost."),L=!0}function Re(){console.log("THREE.WebGLRenderer: Context Restored."),L=!1;const e=Q.autoReset,t=pe.enabled,r=pe.autoUpdate,n=pe.needsUpdate,i=pe.type;Me(),Q.autoReset=e,pe.enabled=t,pe.autoUpdate=r,pe.needsUpdate=n,pe.type=i}function _e(e){console.error("THREE.WebGLRenderer: A WebGL context could not be created. Reason: ",e.statusMessage)}function Ee(e){const t=e.target;t.removeEventListener("dispose",Ee),function(e){(function(e){const t=Z.get(e).programs;void 0!==t&&(t.forEach((function(e){oe.releaseProgram(e)})),e.isShaderMaterial&&oe.releaseShaderCache(e))})(e),Z.remove(e)}(t)}function Ce(e,t,r){!0===e.transparent&&e.side===DoubleSide&&!1===e.forceSinglePass?(e.side=BackSide,e.needsUpdate=!0,Be(e,t,r),e.side=FrontSide,e.needsUpdate=!0,Be(e,t,r),e.side=DoubleSide):Be(e,t,r)}this.xr=we,this.getContext=function(){return xe},this.getContextAttributes=function(){return xe.getContextAttributes()},this.forceContextLoss=function(){const e=Y.get("WEBGL_lose_context");e&&e.loseContext()},this.forceContextRestore=function(){const e=Y.get("WEBGL_lose_context");e&&e.restoreContext()},this.getPixelRatio=function(){return P},this.setPixelRatio=function(e){void 0!==e&&(P=e,this.setSize(A,y,!1))},this.getSize=function(e){return e.set(A,y)},this.setSize=function(e,r,n=!0){we.isPresenting?console.warn("THREE.WebGLRenderer: Can't change size while VR device is presenting."):(A=e,y=r,t.width=Math.floor(e*P),t.height=Math.floor(r*P),!0===n&&(t.style.width=e+"px",t.style.height=r+"px"),this.setViewport(0,0,e,r))},this.getDrawingBufferSize=function(e){return e.set(A*P,y*P).floor()},this.setDrawingBufferSize=function(e,r,n){A=e,y=r,P=n,t.width=Math.floor(e*n),t.height=Math.floor(r*n),this.setViewport(0,0,e,r)},this.getCurrentViewport=function(e){return e.copy(E)},this.getViewport=function(e){return e.copy(F)},this.setViewport=function(e,t,r,n){e.isVector4?F.set(e.x,e.y,e.z,e.w):F.set(e,t,r,n),J.viewport(E.copy(F).multiplyScalar(P).round())},this.getScissor=function(e){return e.copy(B)},this.setScissor=function(e,t,r,n){e.isVector4?B.set(e.x,e.y,e.z,e.w):B.set(e,t,r,n),J.scissor(C.copy(B).multiplyScalar(P).round())},this.getScissorTest=function(){return I},this.setScissorTest=function(e){J.setScissorTest(I=e)},this.setOpaqueSort=function(e){U=e},this.setTransparentSort=function(e){D=e},this.getClearColor=function(e){return e.copy(ce.getClearColor())},this.setClearColor=function(){ce.setClearColor.apply(ce,arguments)},this.getClearAlpha=function(){return ce.getClearAlpha()},this.setClearAlpha=function(){ce.setClearAlpha.apply(ce,arguments)},this.clear=function(e=!0,t=!0,r=!0){let n=0;if(e){let e=!1;if(null!==S){const t=S.texture.format;e=t===RGBAIntegerFormat||t===RGIntegerFormat||t===RedIntegerFormat}if(e){const e=S.texture.type,t=e===UnsignedByteType||e===UnsignedIntType||e===UnsignedShortType||e===UnsignedInt248Type||e===UnsignedShort4444Type||e===UnsignedShort5551Type,r=ce.getClearColor(),n=ce.getClearAlpha(),i=r.r,s=r.g,o=r.b;t?(g[0]=i,g[1]=s,g[2]=o,g[3]=n,xe.clearBufferuiv(xe.COLOR,0,g)):(h[0]=i,h[1]=s,h[2]=o,h[3]=n,xe.clearBufferiv(xe.COLOR,0,h))}else n|=xe.COLOR_BUFFER_BIT}t&&(n|=xe.DEPTH_BUFFER_BIT),r&&(n|=xe.STENCIL_BUFFER_BIT,this.state.buffers.stencil.setMask(4294967295)),xe.clear(n)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){t.removeEventListener("webglcontextlost",Se,!1),t.removeEventListener("webglcontextrestored",Re,!1),t.removeEventListener("webglcontextcreationerror",_e,!1),le.dispose(),ue.dispose(),Z.dispose(),te.dispose(),re.dispose(),se.dispose(),be.dispose(),Te.dispose(),oe.dispose(),we.dispose(),we.removeEventListener("sessionstart",Ge),we.removeEventListener("sessionend",We),Ae.stop()},this.renderBufferDirect=function(e,t,r,n,i,s){null===t&&(t=z);const o=i.isMesh&&i.matrixWorld.determinant()<0,a=function(e,t,r,n,i){!0!==t.isScene&&(t=z);ee.resetTextureUnits();const s=t.fog,o=n.isMeshStandardMaterial?t.environment:null,a=null===S?x.outputColorSpace:!0===S.isXRRenderTarget?S.texture.colorSpace:LinearSRGBColorSpace,l=(n.isMeshStandardMaterial?re:te).get(n.envMap||o),u=!0===n.vertexColors&&!!r.attributes.color&&4===r.attributes.color.itemSize,d=!!r.attributes.tangent&&(!!n.normalMap||n.anisotropy>0),p=!!r.morphAttributes.position,c=!!r.morphAttributes.normal,g=!!r.morphAttributes.color;let h=NoToneMapping;n.toneMapped&&(null!==S&&!0!==S.isXRRenderTarget||(h=x.toneMapping));const f=r.morphAttributes.position||r.morphAttributes.normal||r.morphAttributes.color,b=void 0!==f?f.length:0,T=Z.get(n),L=m.state.lights;if(!0===O&&(!0===V||e!==_)){const t=e===_&&n.id===R;de.setState(n,e,t)}let M=!1;n.version===T.__version?T.needsLights&&T.lightsStateVersion!==L.state.version||T.outputColorSpace!==a||i.isBatchedMesh&&!1===T.batching?M=!0:i.isBatchedMesh||!0!==T.batching?i.isBatchedMesh&&!0===T.batchingColor&&null===i.colorTexture||i.isBatchedMesh&&!1===T.batchingColor&&null!==i.colorTexture||i.isInstancedMesh&&!1===T.instancing?M=!0:i.isInstancedMesh||!0!==T.instancing?i.isSkinnedMesh&&!1===T.skinning?M=!0:i.isSkinnedMesh||!0!==T.skinning?i.isInstancedMesh&&!0===T.instancingColor&&null===i.instanceColor||i.isInstancedMesh&&!1===T.instancingColor&&null!==i.instanceColor||i.isInstancedMesh&&!0===T.instancingMorph&&null===i.morphTexture||i.isInstancedMesh&&!1===T.instancingMorph&&null!==i.morphTexture||T.envMap!==l||!0===n.fog&&T.fog!==s?M=!0:void 0===T.numClippingPlanes||T.numClippingPlanes===de.numPlanes&&T.numIntersection===de.numIntersection?(T.vertexAlphas!==u||T.vertexTangents!==d||T.morphTargets!==p||T.morphNormals!==c||T.morphColors!==g||T.toneMapping!==h||T.morphTargetsCount!==b)&&(M=!0):M=!0:M=!0:M=!0:M=!0:(M=!0,T.__version=n.version);let w=T.currentProgram;!0===M&&(w=Be(n,t,i));let E=!1,C=!1,v=!1;const G=w.getUniforms(),W=T.uniforms;J.useProgram(w.program)&&(E=!0,C=!0,v=!0);n.id!==R&&(R=n.id,C=!0);if(E||_!==e){J.buffers.depth.getReversed()?(N.copy(e.projectionMatrix),toNormalizedProjectionMatrix(N),toReversedProjectionMatrix(N),G.setValue(xe,"projectionMatrix",N)):G.setValue(xe,"projectionMatrix",e.projectionMatrix),G.setValue(xe,"viewMatrix",e.matrixWorldInverse);const t=G.map.cameraPosition;void 0!==t&&t.setValue(xe,K.setFromMatrixPosition(e.matrixWorld)),$.logarithmicDepthBuffer&&G.setValue(xe,"logDepthBufFC",2/(Math.log(e.far+1)/Math.LN2)),(n.isMeshPhongMaterial||n.isMeshToonMaterial||n.isMeshLambertMaterial||n.isMeshBasicMaterial||n.isMeshStandardMaterial||n.isShaderMaterial)&&G.setValue(xe,"isOrthographic",!0===e.isOrthographicCamera),_!==e&&(_=e,C=!0,v=!0)}if(i.isSkinnedMesh){G.setOptional(xe,i,"bindMatrix"),G.setOptional(xe,i,"bindMatrixInverse");const e=i.skeleton;e&&(null===e.boneTexture&&e.computeBoneTexture(),G.setValue(xe,"boneTexture",e.boneTexture,ee))}i.isBatchedMesh&&(G.setOptional(xe,i,"batchingTexture"),G.setValue(xe,"batchingTexture",i._matricesTexture,ee),G.setOptional(xe,i,"batchingIdTexture"),G.setValue(xe,"batchingIdTexture",i._indirectTexture,ee),G.setOptional(xe,i,"batchingColorTexture"),null!==i._colorsTexture&&G.setValue(xe,"batchingColorTexture",i._colorsTexture,ee));const A=r.morphAttributes;void 0===A.position&&void 0===A.normal&&void 0===A.color||ge.update(i,r,w);(C||T.receiveShadow!==i.receiveShadow)&&(T.receiveShadow=i.receiveShadow,G.setValue(xe,"receiveShadow",i.receiveShadow));n.isMeshGouraudMaterial&&null!==n.envMap&&(W.envMap.value=l,W.flipEnvMap.value=l.isCubeTexture&&!1===l.isRenderTargetTexture?-1:1);n.isMeshStandardMaterial&&null===n.envMap&&null!==t.environment&&(W.envMapIntensity.value=t.environmentIntensity);C&&(G.setValue(xe,"toneMappingExposure",x.toneMappingExposure),T.needsLights&&(D=v,(U=W).ambientLightColor.needsUpdate=D,U.lightProbe.needsUpdate=D,U.directionalLights.needsUpdate=D,U.directionalLightShadows.needsUpdate=D,U.pointLights.needsUpdate=D,U.pointLightShadows.needsUpdate=D,U.spotLights.needsUpdate=D,U.spotLightShadows.needsUpdate=D,U.rectAreaLights.needsUpdate=D,U.hemisphereLights.needsUpdate=D),s&&!0===n.fog&&ae.refreshFogUniforms(W,s),ae.refreshMaterialUniforms(W,n,P,y,m.state.transmissionRenderTarget[e.id]),WebGLUniforms.upload(xe,Ie(T),W,ee));var U,D;n.isShaderMaterial&&!0===n.uniformsNeedUpdate&&(WebGLUniforms.upload(xe,Ie(T),W,ee),n.uniformsNeedUpdate=!1);n.isSpriteMaterial&&G.setValue(xe,"center",i.center);if(G.setValue(xe,"modelViewMatrix",i.modelViewMatrix),G.setValue(xe,"normalMatrix",i.normalMatrix),G.setValue(xe,"modelMatrix",i.matrixWorld),n.isShaderMaterial||n.isRawShaderMaterial){const e=n.uniformsGroups;for(let t=0,r=e.length;t<r;t++){const r=e[t];Te.update(r,w),Te.bind(r,w)}}return w}(e,t,r,n,i);J.setMaterial(n,o);let l=r.index,u=1;if(!0===n.wireframe){if(l=ie.getWireframeAttribute(r),void 0===l)return;u=2}const d=r.drawRange,p=r.attributes.position;let c=d.start*u,g=(d.start+d.count)*u;null!==s&&(c=Math.max(c,s.start*u),g=Math.min(g,(s.start+s.count)*u)),null!==l?(c=Math.max(c,0),g=Math.min(g,l.count)):null!=p&&(c=Math.max(c,0),g=Math.min(g,p.count));const h=g-c;if(h<0||h===1/0)return;let f;be.setup(i,n,a,r,l);let b=he;if(null!==l&&(f=ne.get(l),b=fe,b.setIndex(f)),i.isMesh)!0===n.wireframe?(J.setLineWidth(n.wireframeLinewidth*q()),b.setMode(xe.LINES)):b.setMode(xe.TRIANGLES);else if(i.isLine){let e=n.linewidth;void 0===e&&(e=1),J.setLineWidth(e*q()),i.isLineSegments?b.setMode(xe.LINES):i.isLineLoop?b.setMode(xe.LINE_LOOP):b.setMode(xe.LINE_STRIP)}else i.isPoints?b.setMode(xe.POINTS):i.isSprite&&b.setMode(xe.TRIANGLES);if(i.isBatchedMesh)if(null!==i._multiDrawInstances)b.renderMultiDrawInstances(i._multiDrawStarts,i._multiDrawCounts,i._multiDrawCount,i._multiDrawInstances);else if(Y.get("WEBGL_multi_draw"))b.renderMultiDraw(i._multiDrawStarts,i._multiDrawCounts,i._multiDrawCount);else{const e=i._multiDrawStarts,t=i._multiDrawCounts,r=i._multiDrawCount,s=l?ne.get(l).bytesPerElement:1,o=Z.get(n).currentProgram.getUniforms();for(let n=0;n<r;n++)o.setValue(xe,"_gl_DrawID",n),b.render(e[n]/s,t[n])}else if(i.isInstancedMesh)b.renderInstances(c,h,i.count);else if(r.isInstancedBufferGeometry){const e=void 0!==r._maxInstanceCount?r._maxInstanceCount:1/0,t=Math.min(r.instanceCount,e);b.renderInstances(c,h,t)}else b.render(c,h)},this.compile=function(e,t,r=null){null===r&&(r=e),m=ue.get(r),m.init(t),T.push(m),r.traverseVisible((function(e){e.isLight&&e.layers.test(t.layers)&&(m.pushLight(e),e.castShadow&&m.pushShadow(e))})),e!==r&&e.traverseVisible((function(e){e.isLight&&e.layers.test(t.layers)&&(m.pushLight(e),e.castShadow&&m.pushShadow(e))})),m.setupLights();const n=new Set;return e.traverse((function(e){if(!(e.isMesh||e.isPoints||e.isLine||e.isSprite))return;const t=e.material;if(t)if(Array.isArray(t))for(let i=0;i<t.length;i++){const s=t[i];Ce(s,r,e),n.add(s)}else Ce(t,r,e),n.add(t)})),T.pop(),m=null,n},this.compileAsync=function(e,t,r=null){const n=this.compile(e,t,r);return new Promise((t=>{function r(){n.forEach((function(e){Z.get(e).currentProgram.isReady()&&n.delete(e)})),0!==n.size?setTimeout(r,10):t(e)}null!==Y.get("KHR_parallel_shader_compile")?r():setTimeout(r,10)}))};let ve=null;function Ge(){Ae.stop()}function We(){Ae.start()}const Ae=new WebGLAnimation;function ye(e,t,r,n){if(!1===e.visible)return;if(e.layers.test(t.layers))if(e.isGroup)r=e.renderOrder;else if(e.isLOD)!0===e.autoUpdate&&e.update(t);else if(e.isLight)m.pushLight(e),e.castShadow&&m.pushShadow(e);else if(e.isSprite){if(!e.frustumCulled||j.intersectsSprite(e)){n&&k.setFromMatrixPosition(e.matrixWorld).applyMatrix4(H);const t=se.update(e),i=e.material;i.visible&&f.push(e,t,i,r,k.z,null)}}else if((e.isMesh||e.isLine||e.isPoints)&&(!e.frustumCulled||j.intersectsObject(e))){const t=se.update(e),i=e.material;if(n&&(void 0!==e.boundingSphere?(null===e.boundingSphere&&e.computeBoundingSphere(),k.copy(e.boundingSphere.center)):(null===t.boundingSphere&&t.computeBoundingSphere(),k.copy(t.boundingSphere.center)),k.applyMatrix4(e.matrixWorld).applyMatrix4(H)),Array.isArray(i)){const n=t.groups;for(let s=0,o=n.length;s<o;s++){const o=n[s],a=i[o.materialIndex];a&&a.visible&&f.push(e,t,a,r,k.z,o)}}else i.visible&&f.push(e,t,i,r,k.z,null)}const i=e.children;for(let e=0,s=i.length;e<s;e++)ye(i[e],t,r,n)}function Pe(e,t,r,n){const i=e.opaque,s=e.transmissive,o=e.transparent;m.setupLightsView(r),!0===O&&de.setGlobalState(x.clippingPlanes,r),n&&J.viewport(E.copy(n)),i.length>0&&De(i,t,r),s.length>0&&De(s,t,r),o.length>0&&De(o,t,r),J.buffers.depth.setTest(!0),J.buffers.depth.setMask(!0),J.buffers.color.setMask(!0),J.setPolygonOffset(!1)}function Ue(e,t,r,n){if(null!==(!0===r.isScene?r.overrideMaterial:null))return;void 0===m.state.transmissionRenderTarget[n.id]&&(m.state.transmissionRenderTarget[n.id]=new WebGLRenderTarget(1,1,{generateMipmaps:!0,type:Y.has("EXT_color_buffer_half_float")||Y.has("EXT_color_buffer_float")?HalfFloatType:UnsignedByteType,minFilter:LinearMipmapLinearFilter,samples:4,stencilBuffer:i,resolveDepthBuffer:!1,resolveStencilBuffer:!1,colorSpace:ColorManagement.workingColorSpace}));const s=m.state.transmissionRenderTarget[n.id],o=n.viewport||E;s.setSize(o.z,o.w);const a=x.getRenderTarget();x.setRenderTarget(s),x.getClearColor(G),W=x.getClearAlpha(),W<1&&x.setClearColor(16777215,.5),x.clear(),X&&ce.render(r);const l=x.toneMapping;x.toneMapping=NoToneMapping;const u=n.viewport;if(void 0!==n.viewport&&(n.viewport=void 0),m.setupLightsView(n),!0===O&&de.setGlobalState(x.clippingPlanes,n),De(e,r,n),ee.updateMultisampleRenderTarget(s),ee.updateRenderTargetMipmap(s),!1===Y.has("WEBGL_multisampled_render_to_texture")){let e=!1;for(let i=0,s=t.length;i<s;i++){const s=t[i],o=s.object,a=s.geometry,l=s.material,u=s.group;if(l.side===DoubleSide&&o.layers.test(n.layers)){const t=l.side;l.side=BackSide,l.needsUpdate=!0,Fe(o,r,n,a,l,u),l.side=t,l.needsUpdate=!0,e=!0}}!0===e&&(ee.updateMultisampleRenderTarget(s),ee.updateRenderTargetMipmap(s))}x.setRenderTarget(a),x.setClearColor(G,W),void 0!==u&&(n.viewport=u),x.toneMapping=l}function De(e,t,r){const n=!0===t.isScene?t.overrideMaterial:null;for(let i=0,s=e.length;i<s;i++){const s=e[i],o=s.object,a=s.geometry,l=null===n?s.material:n,u=s.group;o.layers.test(r.layers)&&Fe(o,t,r,a,l,u)}}function Fe(e,t,r,n,i,s){e.onBeforeRender(x,t,r,n,i,s),e.modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,e.matrixWorld),e.normalMatrix.getNormalMatrix(e.modelViewMatrix),i.onBeforeRender(x,t,r,n,e,s),!0===i.transparent&&i.side===DoubleSide&&!1===i.forceSinglePass?(i.side=BackSide,i.needsUpdate=!0,x.renderBufferDirect(r,t,n,i,e,s),i.side=FrontSide,i.needsUpdate=!0,x.renderBufferDirect(r,t,n,i,e,s),i.side=DoubleSide):x.renderBufferDirect(r,t,n,i,e,s),e.onAfterRender(x,t,r,n,i,s)}function Be(e,t,r){!0!==t.isScene&&(t=z);const n=Z.get(e),i=m.state.lights,s=m.state.shadowsArray,o=i.state.version,a=oe.getParameters(e,i.state,s,t,r),l=oe.getProgramCacheKey(a);let u=n.programs;n.environment=e.isMeshStandardMaterial?t.environment:null,n.fog=t.fog,n.envMap=(e.isMeshStandardMaterial?re:te).get(e.envMap||n.environment),n.envMapRotation=null!==n.environment&&null===e.envMap?t.environmentRotation:e.envMapRotation,void 0===u&&(e.addEventListener("dispose",Ee),u=new Map,n.programs=u);let d=u.get(l);if(void 0!==d){if(n.currentProgram===d&&n.lightsStateVersion===o)return je(e,a),d}else a.uniforms=oe.getUniforms(e),e.onBeforeCompile(a,x),d=oe.acquireProgram(a,l),u.set(l,d),n.uniforms=a.uniforms;const p=n.uniforms;return(e.isShaderMaterial||e.isRawShaderMaterial)&&!0!==e.clipping||(p.clippingPlanes=de.uniform),je(e,a),n.needsLights=function(e){return e.isMeshLambertMaterial||e.isMeshToonMaterial||e.isMeshPhongMaterial||e.isMeshStandardMaterial||e.isShadowMaterial||e.isShaderMaterial&&!0===e.lights}(e),n.lightsStateVersion=o,n.needsLights&&(p.ambientLightColor.value=i.state.ambient,p.lightProbe.value=i.state.probe,p.directionalLights.value=i.state.directional,p.directionalLightShadows.value=i.state.directionalShadow,p.spotLights.value=i.state.spot,p.spotLightShadows.value=i.state.spotShadow,p.rectAreaLights.value=i.state.rectArea,p.ltc_1.value=i.state.rectAreaLTC1,p.ltc_2.value=i.state.rectAreaLTC2,p.pointLights.value=i.state.point,p.pointLightShadows.value=i.state.pointShadow,p.hemisphereLights.value=i.state.hemi,p.directionalShadowMap.value=i.state.directionalShadowMap,p.directionalShadowMatrix.value=i.state.directionalShadowMatrix,p.spotShadowMap.value=i.state.spotShadowMap,p.spotLightMatrix.value=i.state.spotLightMatrix,p.spotLightMap.value=i.state.spotLightMap,p.pointShadowMap.value=i.state.pointShadowMap,p.pointShadowMatrix.value=i.state.pointShadowMatrix),n.currentProgram=d,n.uniformsList=null,d}function Ie(e){if(null===e.uniformsList){const t=e.currentProgram.getUniforms();e.uniformsList=WebGLUniforms.seqWithValue(t.seq,e.uniforms)}return e.uniformsList}function je(e,t){const r=Z.get(e);r.outputColorSpace=t.outputColorSpace,r.batching=t.batching,r.batchingColor=t.batchingColor,r.instancing=t.instancing,r.instancingColor=t.instancingColor,r.instancingMorph=t.instancingMorph,r.skinning=t.skinning,r.morphTargets=t.morphTargets,r.morphNormals=t.morphNormals,r.morphColors=t.morphColors,r.morphTargetsCount=t.morphTargetsCount,r.numClippingPlanes=t.numClippingPlanes,r.numIntersection=t.numClipIntersection,r.vertexAlphas=t.vertexAlphas,r.vertexTangents=t.vertexTangents,r.toneMapping=t.toneMapping}Ae.setAnimationLoop((function(e){ve&&ve(e)})),"undefined"!=typeof self&&Ae.setContext(self),this.setAnimationLoop=function(e){ve=e,we.setAnimationLoop(e),null===e?Ae.stop():Ae.start()},we.addEventListener("sessionstart",Ge),we.addEventListener("sessionend",We),this.render=function(e,t){if(void 0!==t&&!0!==t.isCamera)return void console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");if(!0===L)return;if(!0===e.matrixWorldAutoUpdate&&e.updateMatrixWorld(),null===t.parent&&!0===t.matrixWorldAutoUpdate&&t.updateMatrixWorld(),!0===we.enabled&&!0===we.isPresenting&&(!0===we.cameraAutoUpdate&&we.updateCamera(t),t=we.getCamera()),!0===e.isScene&&e.onBeforeRender(x,e,t,S),m=ue.get(e,T.length),m.init(t),T.push(m),H.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),j.setFromProjectionMatrix(H),V=this.localClippingEnabled,O=de.init(this.clippingPlanes,V),f=le.get(e,b.length),f.init(),b.push(f),!0===we.enabled&&!0===we.isPresenting){const e=x.xr.getDepthSensingMesh();null!==e&&ye(e,t,-1/0,x.sortObjects)}ye(e,t,0,x.sortObjects),f.finish(),!0===x.sortObjects&&f.sort(U,D),X=!1===we.enabled||!1===we.isPresenting||!1===we.hasDepthSensing(),X&&ce.addToRenderList(f,e),this.info.render.frame++,!0===O&&de.beginShadows();const r=m.state.shadowsArray;pe.render(r,e,t),!0===O&&de.endShadows(),!0===this.info.autoReset&&this.info.reset();const n=f.opaque,i=f.transmissive;if(m.setupLights(),t.isArrayCamera){const r=t.cameras;if(i.length>0)for(let t=0,s=r.length;t<s;t++){Ue(n,i,e,r[t])}X&&ce.render(e);for(let t=0,n=r.length;t<n;t++){const n=r[t];Pe(f,e,n,n.viewport)}}else i.length>0&&Ue(n,i,e,t),X&&ce.render(e),Pe(f,e,t);null!==S&&(ee.updateMultisampleRenderTarget(S),ee.updateRenderTargetMipmap(S)),!0===e.isScene&&e.onAfterRender(x,e,t),be.resetDefaultState(),R=-1,_=null,T.pop(),T.length>0?(m=T[T.length-1],!0===O&&de.setGlobalState(x.clippingPlanes,m.state.camera)):m=null,b.pop(),f=b.length>0?b[b.length-1]:null},this.getActiveCubeFace=function(){return M},this.getActiveMipmapLevel=function(){return w},this.getRenderTarget=function(){return S},this.setRenderTargetTextures=function(e,t,r){Z.get(e.texture).__webglTexture=t,Z.get(e.depthTexture).__webglTexture=r;const n=Z.get(e);n.__hasExternalTextures=!0,n.__autoAllocateDepthBuffer=void 0===r,n.__autoAllocateDepthBuffer||!0===Y.has("WEBGL_multisampled_render_to_texture")&&(console.warn("THREE.WebGLRenderer: Render-to-texture extension was disabled because an external texture was provided"),n.__useRenderToTexture=!1)},this.setRenderTargetFramebuffer=function(e,t){const r=Z.get(e);r.__webglFramebuffer=t,r.__useDefaultFramebuffer=void 0===t},this.setRenderTarget=function(e,t=0,r=0){S=e,M=t,w=r;let n=!0,i=null,s=!1,o=!1;if(e){const a=Z.get(e);if(void 0!==a.__useDefaultFramebuffer)J.bindFramebuffer(xe.FRAMEBUFFER,null),n=!1;else if(void 0===a.__webglFramebuffer)ee.setupRenderTarget(e);else if(a.__hasExternalTextures)ee.rebindTextures(e,Z.get(e.texture).__webglTexture,Z.get(e.depthTexture).__webglTexture);else if(e.depthBuffer){const t=e.depthTexture;if(a.__boundDepthTexture!==t){if(null!==t&&Z.has(t)&&(e.width!==t.image.width||e.height!==t.image.height))throw new Error("WebGLRenderTarget: Attached DepthTexture is initialized to the incorrect size.");ee.setupDepthRenderbuffer(e)}}const l=e.texture;(l.isData3DTexture||l.isDataArrayTexture||l.isCompressedArrayTexture)&&(o=!0);const u=Z.get(e).__webglFramebuffer;e.isWebGLCubeRenderTarget?(i=Array.isArray(u[t])?u[t][r]:u[t],s=!0):i=e.samples>0&&!1===ee.useMultisampledRTT(e)?Z.get(e).__webglMultisampledFramebuffer:Array.isArray(u)?u[r]:u,E.copy(e.viewport),C.copy(e.scissor),v=e.scissorTest}else E.copy(F).multiplyScalar(P).floor(),C.copy(B).multiplyScalar(P).floor(),v=I;if(J.bindFramebuffer(xe.FRAMEBUFFER,i)&&n&&J.drawBuffers(e,i),J.viewport(E),J.scissor(C),J.setScissorTest(v),s){const n=Z.get(e.texture);xe.framebufferTexture2D(xe.FRAMEBUFFER,xe.COLOR_ATTACHMENT0,xe.TEXTURE_CUBE_MAP_POSITIVE_X+t,n.__webglTexture,r)}else if(o){const n=Z.get(e.texture),i=t||0;xe.framebufferTextureLayer(xe.FRAMEBUFFER,xe.COLOR_ATTACHMENT0,n.__webglTexture,r||0,i)}R=-1},this.readRenderTargetPixels=function(e,t,r,n,i,s,o){if(!e||!e.isWebGLRenderTarget)return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");let a=Z.get(e).__webglFramebuffer;if(e.isWebGLCubeRenderTarget&&void 0!==o&&(a=a[o]),a){J.bindFramebuffer(xe.FRAMEBUFFER,a);try{const o=e.texture,a=o.format,l=o.type;if(!$.textureFormatReadable(a))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");if(!$.textureTypeReadable(l))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");t>=0&&t<=e.width-n&&r>=0&&r<=e.height-i&&xe.readPixels(t,r,n,i,me.convert(a),me.convert(l),s)}finally{const e=null!==S?Z.get(S).__webglFramebuffer:null;J.bindFramebuffer(xe.FRAMEBUFFER,e)}}},this.readRenderTargetPixelsAsync=async function(e,t,r,n,i,s,o){if(!e||!e.isWebGLRenderTarget)throw new Error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");let a=Z.get(e).__webglFramebuffer;if(e.isWebGLCubeRenderTarget&&void 0!==o&&(a=a[o]),a){const o=e.texture,l=o.format,u=o.type;if(!$.textureFormatReadable(l))throw new Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: renderTarget is not in RGBA or implementation defined format.");if(!$.textureTypeReadable(u))throw new Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: renderTarget is not in UnsignedByteType or implementation defined type.");if(t>=0&&t<=e.width-n&&r>=0&&r<=e.height-i){J.bindFramebuffer(xe.FRAMEBUFFER,a);const e=xe.createBuffer();xe.bindBuffer(xe.PIXEL_PACK_BUFFER,e),xe.bufferData(xe.PIXEL_PACK_BUFFER,s.byteLength,xe.STREAM_READ),xe.readPixels(t,r,n,i,me.convert(l),me.convert(u),0);const o=null!==S?Z.get(S).__webglFramebuffer:null;J.bindFramebuffer(xe.FRAMEBUFFER,o);const d=xe.fenceSync(xe.SYNC_GPU_COMMANDS_COMPLETE,0);return xe.flush(),await probeAsync(xe,d,4),xe.bindBuffer(xe.PIXEL_PACK_BUFFER,e),xe.getBufferSubData(xe.PIXEL_PACK_BUFFER,0,s),xe.deleteBuffer(e),xe.deleteSync(d),s}throw new Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: requested read bounds are out of range.")}},this.copyFramebufferToTexture=function(e,t=null,r=0){!0!==e.isTexture&&(warnOnce("WebGLRenderer: copyFramebufferToTexture function signature has changed."),t=arguments[0]||null,e=arguments[1]);const n=Math.pow(2,-r),i=Math.floor(e.image.width*n),s=Math.floor(e.image.height*n),o=null!==t?t.x:0,a=null!==t?t.y:0;ee.setTexture2D(e,0),xe.copyTexSubImage2D(xe.TEXTURE_2D,r,0,0,o,a,i,s),J.unbindTexture()},this.copyTextureToTexture=function(e,t,r=null,n=null,i=0){let s,o,a,l,u,d,p,c,g;!0!==e.isTexture&&(warnOnce("WebGLRenderer: copyTextureToTexture function signature has changed."),n=arguments[0]||null,e=arguments[1],t=arguments[2],i=arguments[3]||0,r=null);const h=e.isCompressedTexture?e.mipmaps[i]:e.image;null!==r?(s=r.max.x-r.min.x,o=r.max.y-r.min.y,a=r.isBox3?r.max.z-r.min.z:1,l=r.min.x,u=r.min.y,d=r.isBox3?r.min.z:0):(s=h.width,o=h.height,a=h.depth||1,l=0,u=0,d=0),null!==n?(p=n.x,c=n.y,g=n.z):(p=0,c=0,g=0);const f=me.convert(t.format),m=me.convert(t.type);let b;t.isData3DTexture?(ee.setTexture3D(t,0),b=xe.TEXTURE_3D):t.isDataArrayTexture||t.isCompressedArrayTexture?(ee.setTexture2DArray(t,0),b=xe.TEXTURE_2D_ARRAY):(ee.setTexture2D(t,0),b=xe.TEXTURE_2D),xe.pixelStorei(xe.UNPACK_FLIP_Y_WEBGL,t.flipY),xe.pixelStorei(xe.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),xe.pixelStorei(xe.UNPACK_ALIGNMENT,t.unpackAlignment);const T=xe.getParameter(xe.UNPACK_ROW_LENGTH),x=xe.getParameter(xe.UNPACK_IMAGE_HEIGHT),L=xe.getParameter(xe.UNPACK_SKIP_PIXELS),M=xe.getParameter(xe.UNPACK_SKIP_ROWS),w=xe.getParameter(xe.UNPACK_SKIP_IMAGES);xe.pixelStorei(xe.UNPACK_ROW_LENGTH,h.width),xe.pixelStorei(xe.UNPACK_IMAGE_HEIGHT,h.height),xe.pixelStorei(xe.UNPACK_SKIP_PIXELS,l),xe.pixelStorei(xe.UNPACK_SKIP_ROWS,u),xe.pixelStorei(xe.UNPACK_SKIP_IMAGES,d);const S=e.isDataArrayTexture||e.isData3DTexture,R=t.isDataArrayTexture||t.isData3DTexture;if(e.isRenderTargetTexture||e.isDepthTexture){const r=Z.get(e),n=Z.get(t),h=Z.get(r.__renderTarget),f=Z.get(n.__renderTarget);J.bindFramebuffer(xe.READ_FRAMEBUFFER,h.__webglFramebuffer),J.bindFramebuffer(xe.DRAW_FRAMEBUFFER,f.__webglFramebuffer);for(let r=0;r<a;r++)S&&xe.framebufferTextureLayer(xe.READ_FRAMEBUFFER,xe.COLOR_ATTACHMENT0,Z.get(e).__webglTexture,i,d+r),e.isDepthTexture?(R&&xe.framebufferTextureLayer(xe.DRAW_FRAMEBUFFER,xe.COLOR_ATTACHMENT0,Z.get(t).__webglTexture,i,g+r),xe.blitFramebuffer(l,u,s,o,p,c,s,o,xe.DEPTH_BUFFER_BIT,xe.NEAREST)):R?xe.copyTexSubImage3D(b,i,p,c,g+r,l,u,s,o):xe.copyTexSubImage2D(b,i,p,c,g+r,l,u,s,o);J.bindFramebuffer(xe.READ_FRAMEBUFFER,null),J.bindFramebuffer(xe.DRAW_FRAMEBUFFER,null)}else R?e.isDataTexture||e.isData3DTexture?xe.texSubImage3D(b,i,p,c,g,s,o,a,f,m,h.data):t.isCompressedArrayTexture?xe.compressedTexSubImage3D(b,i,p,c,g,s,o,a,f,h.data):xe.texSubImage3D(b,i,p,c,g,s,o,a,f,m,h):e.isDataTexture?xe.texSubImage2D(xe.TEXTURE_2D,i,p,c,s,o,f,m,h.data):e.isCompressedTexture?xe.compressedTexSubImage2D(xe.TEXTURE_2D,i,p,c,h.width,h.height,f,h.data):xe.texSubImage2D(xe.TEXTURE_2D,i,p,c,s,o,f,m,h);xe.pixelStorei(xe.UNPACK_ROW_LENGTH,T),xe.pixelStorei(xe.UNPACK_IMAGE_HEIGHT,x),xe.pixelStorei(xe.UNPACK_SKIP_PIXELS,L),xe.pixelStorei(xe.UNPACK_SKIP_ROWS,M),xe.pixelStorei(xe.UNPACK_SKIP_IMAGES,w),0===i&&t.generateMipmaps&&xe.generateMipmap(b),J.unbindTexture()},this.copyTextureToTexture3D=function(e,t,r=null,n=null,i=0){return!0!==e.isTexture&&(warnOnce("WebGLRenderer: copyTextureToTexture3D function signature has changed."),r=arguments[0]||null,n=arguments[1]||null,e=arguments[2],t=arguments[3],i=arguments[4]||0),warnOnce('WebGLRenderer: copyTextureToTexture3D function has been deprecated. Use "copyTextureToTexture" instead.'),this.copyTextureToTexture(e,t,r,n,i)},this.initRenderTarget=function(e){void 0===Z.get(e).__webglFramebuffer&&ee.setupRenderTarget(e)},this.initTexture=function(e){e.isCubeTexture?ee.setTextureCube(e,0):e.isData3DTexture?ee.setTexture3D(e,0):e.isDataArrayTexture||e.isCompressedArrayTexture?ee.setTexture2DArray(e,0):ee.setTexture2D(e,0),J.unbindTexture()},this.resetState=function(){M=0,w=0,S=null,J.reset(),be.reset()},"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}get coordinateSystem(){return WebGLCoordinateSystem}get outputColorSpace(){return this._outputColorSpace}set outputColorSpace(e){this._outputColorSpace=e;const t=this.getContext();t.drawingBufferColorspace=ColorManagement._getDrawingBufferColorSpace(e),t.unpackColorSpace=ColorManagement._getUnpackColorSpace()}}export{WebGLRenderer};
//# sourceMappingURL=/sm/4e0f7c740dc72b9742133543dfae08a6a1d66b7555b2f58483d56174ffbe5433.map