/**
 * Minified by jsDelivr using Terser v5.19.2.
 * Original file: /npm/three@0.170.0/examples/jsm/objects/LensflareMesh.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{AdditiveBlending,Box2,BufferGeometry,Color,FramebufferTexture,InterleavedBuffer,InterleavedBufferAttribute,Mesh,MeshBasicNodeMaterial,NodeMaterial,UnsignedByteType,Vector2,Vector3,Vector4}from"three";import{texture,textureLoad,uv,ivec2,vec2,vec4,positionGeometry,reference,varyingProperty,materialReference,Fn,Node}from"three/tsl";class LensflareMesh extends Mesh{constructor(){super(LensflareMesh.Geometry,new MeshBasicNodeMaterial({opacity:0,transparent:!0})),this.isLensflare=!0,this.type="LensflareMesh",this.frustumCulled=!1,this.renderOrder=1/0;const e=new Vector3,t=new FramebufferTexture(16,16),r=new FramebufferTexture(16,16);let n=UnsignedByteType;const s=LensflareMesh.Geometry,o={scale:new Vector2,positionScreen:new Vector3},i=reference("scale","vec2",o),a=reference("positionScreen","vec3",o),c=vec4(positionGeometry.xy.mul(i).add(a.xy),a.z,1),d=new NodeMaterial;d.depthTest=!0,d.depthWrite=!1,d.transparent=!1,d.fog=!1,d.type="Lensflare-1a",d.vertexNode=c,d.fragmentNode=vec4(1,0,1,1);const l=new NodeMaterial;l.depthTest=!1,l.depthWrite=!1,l.transparent=!1,l.fog=!1,l.type="Lensflare-1b",l.vertexNode=c,l.fragmentNode=texture(t,vec2(uv().flipY()));const u=new Mesh(s,d),f=[],p=[],x=new NodeMaterial;x.transparent=!0,x.blending=AdditiveBlending,x.depthWrite=!1,x.depthTest=!1,x.fog=!1,x.type="Lensflare-2",x.screenPosition=new Vector3,x.scale=new Vector2,x.occlusionMap=r,x.vertexNode=Fn((({material:e})=>{const t=materialReference("scale","vec2"),r=materialReference("screenPosition","vec3"),n=e.occlusionMap,s=positionGeometry.xy.toVar(),o=textureLoad(n,ivec2(2,2)).toVar();o.addAssign(textureLoad(n,ivec2(8,2))),o.addAssign(textureLoad(n,ivec2(14,2))),o.addAssign(textureLoad(n,ivec2(14,8))),o.addAssign(textureLoad(n,ivec2(14,14))),o.addAssign(textureLoad(n,ivec2(8,14))),o.addAssign(textureLoad(n,ivec2(2,14))),o.addAssign(textureLoad(n,ivec2(2,8))),o.addAssign(textureLoad(n,ivec2(8,8)));const i=varyingProperty("float","vVisibility");return i.assign(o.r.div(9)),i.mulAssign(o.g.div(9).oneMinus()),i.mulAssign(o.b.div(9)),vec4(s.mul(t).add(r.xy).xy,r.z,1)}))(),x.fragmentNode=Fn((()=>{const e=reference("color","color"),t=reference("map","texture"),r=varyingProperty("float","vVisibility"),n=t.toVar();return n.a.mulAssign(r),n.rgb.mulAssign(e),n}))(),this.addElement=function(e){f.push(e)};const y=o.positionScreen,v=new Vector4(0,0,16,16),m=new Box2,g=new Vector4,h=new Node;this.onBeforeRender=(i,a,c)=>{i.getViewport(g),g.multiplyScalar(window.devicePixelRatio);const w=i.getRenderTarget(),M=null!==w?w.texture.type:UnsignedByteType;n!==M&&(t.dispose(),r.dispose(),t.type=r.type=M,n=M);const L=g.w/g.z,A=g.z/2,b=g.w/2,B=16/g.w;if(o.scale.set(B*L,B),m.min.set(g.x,g.y),m.max.set(g.x+(g.z-16),g.y+(g.w-16)),e.setFromMatrixPosition(this.matrixWorld),e.applyMatrix4(c.matrixWorldInverse),!(e.z>0)&&(y.copy(e).applyMatrix4(c.projectionMatrix),v.x=g.x+y.x*A+A-8,v.y=g.y-y.y*b+b-8,m.containsPoint(v))){i.copyFramebufferToTexture(t,v),i.renderObject(u,a,c,s,d,null,h),i.copyFramebufferToTexture(r,v),i.renderObject(u,a,c,s,l,null,h);const e=2*-y.x,n=2*-y.y;for(let t=0,r=f.length;t<r;t++){const r=f[t];let o=p[t];void 0===o&&(o=p[t]=new Mesh(s,x),o.color=r.color.convertSRGBToLinear(),o.map=r.texture),x.screenPosition.x=y.x+e*r.distance,x.screenPosition.y=y.y-n*r.distance,x.screenPosition.z=y.z;const d=r.size/g.w;x.scale.set(d*L,d),i.renderObject(o,a,c,s,x,null,h)}}},this.dispose=function(){d.dispose(),l.dispose(),x.dispose(),t.dispose(),r.dispose();for(let e=0,t=f.length;e<t;e++)f[e].texture.dispose()}}}class LensflareElement{constructor(e,t=1,r=0,n=new Color(16777215)){this.texture=e,this.size=t,this.distance=r,this.color=n}}LensflareMesh.Geometry=function(){const e=new BufferGeometry,t=new Float32Array([-1,-1,0,0,0,1,-1,0,1,0,1,1,0,1,1,-1,1,0,0,1]),r=new InterleavedBuffer(t,5);return e.setIndex([0,1,2,0,2,3]),e.setAttribute("position",new InterleavedBufferAttribute(r,3,0,!1)),e.setAttribute("uv",new InterleavedBufferAttribute(r,2,3,!1)),e}();export{LensflareMesh,LensflareElement};
//# sourceMappingURL=/sm/18ca16aa9b40cbd7019cc79c8d11ee5d7e3c042513a28aae7ca687d28bda9a0f.map