/**
 * Minified by jsDelivr using Terser v5.19.2.
 * Original file: /npm/three@0.170.0/examples/jsm/loaders/KTX2Loader.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{CompressedTexture,CompressedArrayTexture,CompressedCubeTexture,Data3DTexture,DataTexture,FileLoader,FloatType,HalfFloatType,NoColorSpace,LinearFilter,LinearMipmapLinearFilter,LinearSRGBColorSpace,Loader,RedFormat,RGB_BPTC_UNSIGNED_Format,RGB_ETC1_Format,RGB_ETC2_Format,RGB_PVRTC_4BPPV1_Format,RGBA_ASTC_4x4_Format,RGBA_ASTC_6x6_Format,RGBA_BPTC_Format,RGBA_ETC2_EAC_Format,RGBA_PVRTC_4BPPV1_Format,RGBA_S3TC_DXT5_Format,RGBA_S3TC_DXT1_Format,RGBAFormat,RGFormat,SRGBColorSpace,UnsignedByteType}from"three";import{WorkerPool}from"../utils/WorkerPool.js";import{read,KHR_DF_FLAG_ALPHA_PREMULTIPLIED,KHR_DF_TRANSFER_SRGB,KHR_SUPERCOMPRESSION_NONE,KHR_SUPERCOMPRESSION_ZSTD,VK_FORMAT_UNDEFINED,VK_FORMAT_R16_SFLOAT,VK_FORMAT_R16G16_SFLOAT,VK_FORMAT_R16G16B16A16_SFLOAT,VK_FORMAT_R32_SFLOAT,VK_FORMAT_R32G32_SFLOAT,VK_FORMAT_R32G32B32A32_SFLOAT,VK_FORMAT_R8_SRGB,VK_FORMAT_R8_UNORM,VK_FORMAT_R8G8_SRGB,VK_FORMAT_R8G8_UNORM,VK_FORMAT_R8G8B8A8_SRGB,VK_FORMAT_R8G8B8A8_UNORM,VK_FORMAT_ASTC_4x4_SFLOAT_BLOCK_EXT,VK_FORMAT_ASTC_6x6_SRGB_BLOCK,VK_FORMAT_ASTC_6x6_UNORM_BLOCK,KHR_DF_PRIMARIES_UNSPECIFIED,KHR_DF_PRIMARIES_BT709,KHR_DF_PRIMARIES_DISPLAYP3}from"../libs/ktx-parse.module.js";import{ZSTDDecoder}from"../libs/zstddec.module.js";import{DisplayP3ColorSpace,LinearDisplayP3ColorSpace}from"../math/ColorSpaces.js";const _taskCache=new WeakMap;let _zstd,_activeLoaders=0;class KTX2Loader extends Loader{constructor(e){super(e),this.transcoderPath="",this.transcoderBinary=null,this.transcoderPending=null,this.workerPool=new WorkerPool,this.workerSourceURL="",this.workerConfig=null,"undefined"!=typeof MSC_TRANSCODER&&console.warn('THREE.KTX2Loader: Please update to latest "basis_transcoder". "msc_basis_transcoder" is no longer supported in three.js r125+.')}setTranscoderPath(e){return this.transcoderPath=e,this}setWorkerLimit(e){return this.workerPool.setWorkerLimit(e),this}async detectSupportAsync(e){return this.workerConfig={astcSupported:await e.hasFeatureAsync("texture-compression-astc"),astcHDRSupported:!1,etc1Supported:await e.hasFeatureAsync("texture-compression-etc1"),etc2Supported:await e.hasFeatureAsync("texture-compression-etc2"),dxtSupported:await e.hasFeatureAsync("texture-compression-bc"),bptcSupported:await e.hasFeatureAsync("texture-compression-bptc"),pvrtcSupported:await e.hasFeatureAsync("texture-compression-pvrtc")},this}detectSupport(e){return!0===e.isWebGPURenderer?this.workerConfig={astcSupported:e.hasFeature("texture-compression-astc"),astcHDRSupported:!1,etc1Supported:e.hasFeature("texture-compression-etc1"),etc2Supported:e.hasFeature("texture-compression-etc2"),dxtSupported:e.hasFeature("texture-compression-bc"),bptcSupported:e.hasFeature("texture-compression-bptc"),pvrtcSupported:e.hasFeature("texture-compression-pvrtc")}:this.workerConfig={astcSupported:e.extensions.has("WEBGL_compressed_texture_astc"),astcHDRSupported:e.extensions.has("WEBGL_compressed_texture_astc")&&e.extensions.get("WEBGL_compressed_texture_astc").getSupportedProfiles().includes("hdr"),etc1Supported:e.extensions.has("WEBGL_compressed_texture_etc1"),etc2Supported:e.extensions.has("WEBGL_compressed_texture_etc"),dxtSupported:e.extensions.has("WEBGL_compressed_texture_s3tc"),bptcSupported:e.extensions.has("EXT_texture_compression_bptc"),pvrtcSupported:e.extensions.has("WEBGL_compressed_texture_pvrtc")||e.extensions.has("WEBKIT_WEBGL_compressed_texture_pvrtc")},this}init(){if(!this.transcoderPending){const e=new FileLoader(this.manager);e.setPath(this.transcoderPath),e.setWithCredentials(this.withCredentials);const t=e.loadAsync("basis_transcoder.js"),r=new FileLoader(this.manager);r.setPath(this.transcoderPath),r.setResponseType("arraybuffer"),r.setWithCredentials(this.withCredentials);const o=r.loadAsync("basis_transcoder.wasm");this.transcoderPending=Promise.all([t,o]).then((([e,t])=>{const r=KTX2Loader.BasisWorker.toString(),o=["/* constants */","let _EngineFormat = "+JSON.stringify(KTX2Loader.EngineFormat),"let _EngineType = "+JSON.stringify(KTX2Loader.EngineType),"let _TranscoderFormat = "+JSON.stringify(KTX2Loader.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(KTX2Loader.BasisFormat),"/* basis_transcoder.js */",e,"/* worker */",r.substring(r.indexOf("{")+1,r.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([o])),this.transcoderBinary=t,this.workerPool.setWorkerCreator((()=>{const e=new Worker(this.workerSourceURL),t=this.transcoderBinary.slice(0);return e.postMessage({type:"init",config:this.workerConfig,transcoderBinary:t},[t]),e}))})),_activeLoaders>0&&console.warn("THREE.KTX2Loader: Multiple active KTX2 loaders may cause performance issues. Use a single KTX2Loader instance, or call .dispose() on old instances."),_activeLoaders++}return this.transcoderPending}load(e,t,r,o){if(null===this.workerConfig)throw new Error("THREE.KTX2Loader: Missing initialization with `.detectSupport( renderer )`.");const a=new FileLoader(this.manager);a.setResponseType("arraybuffer"),a.setWithCredentials(this.withCredentials),a.load(e,(e=>{this.parse(e,t,o)}),r,o)}parse(e,t,r){if(null===this.workerConfig)throw new Error("THREE.KTX2Loader: Missing initialization with `.detectSupport( renderer )`.");if(_taskCache.has(e)){return _taskCache.get(e).promise.then(t).catch(r)}this._createTexture(e).then((e=>t?t(e):null)).catch(r)}_createTextureFrom(e,t){const{type:r,error:o,data:{faces:a,width:s,height:i,format:n,type:_,dfdFlags:T}}=e;if("error"===r)return Promise.reject(o);let p;if(6===t.faceCount)p=new CompressedCubeTexture(a,n,_);else{const e=a[0].mipmaps;p=t.layerCount>1?new CompressedArrayTexture(e,s,i,t.layerCount,n,_):new CompressedTexture(e,s,i,n,_)}return p.minFilter=1===a[0].mipmaps.length?LinearFilter:LinearMipmapLinearFilter,p.magFilter=LinearFilter,p.generateMipmaps=!1,p.needsUpdate=!0,p.colorSpace=parseColorSpace(t),p.premultiplyAlpha=!!(T&KHR_DF_FLAG_ALPHA_PREMULTIPLIED),p}async _createTexture(e,t={}){const r=read(new Uint8Array(e)),o=r.vkFormat===VK_FORMAT_ASTC_4x4_SFLOAT_BLOCK_EXT&&167===r.dataFormatDescriptor[0].colorModel;if(!(r.vkFormat===VK_FORMAT_UNDEFINED||o&&!this.workerConfig.astcHDRSupported))return createRawTexture(r);const a=t,s=this.init().then((()=>this.workerPool.postMessage({type:"transcode",buffer:e,taskConfig:a},[e]))).then((e=>this._createTextureFrom(e.data,r)));return _taskCache.set(e,{promise:s}),s}dispose(){return this.workerPool.dispose(),this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),_activeLoaders--,this}}KTX2Loader.BasisFormat={ETC1S:0,UASTC:1,UASTC_HDR:2},KTX2Loader.TranscoderFormat={ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16,BC6H:22,RGB_HALF:24,RGBA_HALF:25},KTX2Loader.EngineFormat={RGBAFormat:RGBAFormat,RGBA_ASTC_4x4_Format:RGBA_ASTC_4x4_Format,RGB_BPTC_UNSIGNED_Format:RGB_BPTC_UNSIGNED_Format,RGBA_BPTC_Format:RGBA_BPTC_Format,RGBA_ETC2_EAC_Format:RGBA_ETC2_EAC_Format,RGBA_PVRTC_4BPPV1_Format:RGBA_PVRTC_4BPPV1_Format,RGBA_S3TC_DXT5_Format:RGBA_S3TC_DXT5_Format,RGB_ETC1_Format:RGB_ETC1_Format,RGB_ETC2_Format:RGB_ETC2_Format,RGB_PVRTC_4BPPV1_Format:RGB_PVRTC_4BPPV1_Format,RGBA_S3TC_DXT1_Format:RGBA_S3TC_DXT1_Format},KTX2Loader.EngineType={UnsignedByteType:UnsignedByteType,HalfFloatType:HalfFloatType,FloatType:FloatType},KTX2Loader.BasisWorker=function(){let e,t,r;const o=_EngineFormat,a=_EngineType,s=_TranscoderFormat,i=_BasisFormat;self.addEventListener("message",(function(o){const s=o.data;switch(s.type){case"init":e=s.config,n=s.transcoderBinary,t=new Promise((e=>{r={wasmBinary:n,onRuntimeInitialized:e},BASIS(r)})).then((()=>{r.initializeBasis(),void 0===r.KTX2File&&console.warn("THREE.KTX2Loader: Please update Basis Universal transcoder.")}));break;case"transcode":t.then((()=>{try{const{faces:t,buffers:o,width:n,height:R,hasAlpha:d,format:c,type:F,dfdFlags:A}=function(t){const o=new r.KTX2File(new Uint8Array(t));function s(){o.close(),o.delete()}if(!o.isValid())throw s(),new Error("THREE.KTX2Loader:\tInvalid or unsupported .ktx2 file");let n;if(o.isUASTC())n=i.UASTC;else if(o.isETC1S())n=i.ETC1S;else{if(!o.isHDR())throw new Error("THREE.KTX2Loader: Unknown Basis encoding");n=i.UASTC_HDR}const R=o.getWidth(),d=o.getHeight(),c=o.getLayers()||1,F=o.getLevels(),A=o.getFaces(),S=o.getHasAlpha(),l=o.getDFDFlags(),{transcoderFormat:m,engineFormat:C,engineType:B}=function(t,r,o,a){const s=_[t];for(let i=0;i<s.length;i++){const n=s[i];if(n.if&&!e[n.if])continue;if(!n.basisFormat.includes(t))continue;if(a&&n.transcoderFormat.length<2)continue;if(n.needsPowerOfTwo&&(!T(r)||!T(o)))continue;return{transcoderFormat:n.transcoderFormat[a?1:0],engineFormat:n.engineFormat[a?1:0],engineType:n.engineType[0]}}throw new Error("THREE.KTX2Loader: Failed to identify transcoding target.")}(n,R,d,S);if(!R||!d||!F)throw s(),new Error("THREE.KTX2Loader:\tInvalid texture");if(!o.startTranscoding())throw s(),new Error("THREE.KTX2Loader: .startTranscoding failed");const h=[],u=[];for(let e=0;e<A;e++){const t=[];for(let r=0;r<F;r++){const i=[];let n,_;for(let t=0;t<c;t++){const T=o.getImageLevelInfo(r,t,e);0!==e||0!==r||0!==t||T.origWidth%4==0&&T.origHeight%4==0||console.warn("THREE.KTX2Loader: ETC1S and UASTC textures should use multiple-of-four dimensions."),F>1?(n=T.origWidth,_=T.origHeight):(n=T.width,_=T.height);let p=new Uint8Array(o.getImageTranscodedSizeInBytes(r,t,0,m));const R=o.transcodeImage(p,r,t,e,m,0,-1,-1);if(B===a.HalfFloatType&&(p=new Uint16Array(p.buffer,p.byteOffset,p.byteLength/Uint16Array.BYTES_PER_ELEMENT)),!R)throw s(),new Error("THREE.KTX2Loader: .transcodeImage failed.");i.push(p)}const T=p(i);t.push({data:T,width:n,height:_}),u.push(T.buffer)}h.push({mipmaps:t,width:R,height:d,format:C,type:B})}return s(),{faces:h,buffers:u,width:R,height:d,hasAlpha:S,dfdFlags:l,format:C,type:B}}(s.buffer);self.postMessage({type:"transcode",id:s.id,data:{faces:t,width:n,height:R,hasAlpha:d,format:c,type:F,dfdFlags:A}},o)}catch(e){console.error(e),self.postMessage({type:"error",id:s.id,error:e.message})}}))}var n}));const n=[{if:"astcSupported",basisFormat:[i.UASTC],transcoderFormat:[s.ASTC_4x4,s.ASTC_4x4],engineFormat:[o.RGBA_ASTC_4x4_Format,o.RGBA_ASTC_4x4_Format],engineType:[a.UnsignedByteType],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[i.ETC1S,i.UASTC],transcoderFormat:[s.BC7_M5,s.BC7_M5],engineFormat:[o.RGBA_BPTC_Format,o.RGBA_BPTC_Format],engineType:[a.UnsignedByteType],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[i.ETC1S,i.UASTC],transcoderFormat:[s.BC1,s.BC3],engineFormat:[o.RGBA_S3TC_DXT1_Format,o.RGBA_S3TC_DXT5_Format],engineType:[a.UnsignedByteType],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[i.ETC1S,i.UASTC],transcoderFormat:[s.ETC1,s.ETC2],engineFormat:[o.RGB_ETC2_Format,o.RGBA_ETC2_EAC_Format],engineType:[a.UnsignedByteType],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[i.ETC1S,i.UASTC],transcoderFormat:[s.ETC1],engineFormat:[o.RGB_ETC1_Format],engineType:[a.UnsignedByteType],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[i.ETC1S,i.UASTC],transcoderFormat:[s.PVRTC1_4_RGB,s.PVRTC1_4_RGBA],engineFormat:[o.RGB_PVRTC_4BPPV1_Format,o.RGBA_PVRTC_4BPPV1_Format],engineType:[a.UnsignedByteType],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0},{if:"bptcSupported",basisFormat:[i.UASTC_HDR],transcoderFormat:[s.BC6H],engineFormat:[o.RGB_BPTC_UNSIGNED_Format],engineType:[a.HalfFloatType],priorityHDR:1,needsPowerOfTwo:!1},{basisFormat:[i.ETC1S,i.UASTC],transcoderFormat:[s.RGBA32,s.RGBA32],engineFormat:[o.RGBAFormat,o.RGBAFormat],engineType:[a.UnsignedByteType,a.UnsignedByteType],priorityETC1S:100,priorityUASTC:100,needsPowerOfTwo:!1},{basisFormat:[i.UASTC_HDR],transcoderFormat:[s.RGBA_HALF],engineFormat:[o.RGBAFormat],engineType:[a.HalfFloatType],priorityHDR:100,needsPowerOfTwo:!1}],_={[i.ETC1S]:n.filter((e=>e.basisFormat.includes(i.ETC1S))).sort(((e,t)=>e.priorityUASTC-t.priorityUASTC)),[i.UASTC]:n.filter((e=>e.basisFormat.includes(i.UASTC))).sort(((e,t)=>e.priorityUASTC-t.priorityUASTC)),[i.UASTC_HDR]:n.filter((e=>e.basisFormat.includes(i.UASTC_HDR))).sort(((e,t)=>e.priorityHDR-t.priorityHDR))};function T(e){return e<=2||0==(e&e-1)&&0!==e}function p(e){if(1===e.length)return e[0];let t=0;for(let r=0;r<e.length;r++){t+=e[r].byteLength}const r=new Uint8Array(t);let o=0;for(let t=0;t<e.length;t++){const a=e[t];r.set(a,o),o+=a.byteLength}return r}};const UNCOMPRESSED_FORMATS=new Set([RGBAFormat,RGFormat,RedFormat]),FORMAT_MAP={[VK_FORMAT_R32G32B32A32_SFLOAT]:RGBAFormat,[VK_FORMAT_R16G16B16A16_SFLOAT]:RGBAFormat,[VK_FORMAT_R8G8B8A8_UNORM]:RGBAFormat,[VK_FORMAT_R8G8B8A8_SRGB]:RGBAFormat,[VK_FORMAT_R32G32_SFLOAT]:RGFormat,[VK_FORMAT_R16G16_SFLOAT]:RGFormat,[VK_FORMAT_R8G8_UNORM]:RGFormat,[VK_FORMAT_R8G8_SRGB]:RGFormat,[VK_FORMAT_R32_SFLOAT]:RedFormat,[VK_FORMAT_R16_SFLOAT]:RedFormat,[VK_FORMAT_R8_SRGB]:RedFormat,[VK_FORMAT_R8_UNORM]:RedFormat,[VK_FORMAT_ASTC_4x4_SFLOAT_BLOCK_EXT]:RGBA_ASTC_4x4_Format,[VK_FORMAT_ASTC_6x6_SRGB_BLOCK]:RGBA_ASTC_6x6_Format,[VK_FORMAT_ASTC_6x6_UNORM_BLOCK]:RGBA_ASTC_6x6_Format},TYPE_MAP={[VK_FORMAT_R32G32B32A32_SFLOAT]:FloatType,[VK_FORMAT_R16G16B16A16_SFLOAT]:HalfFloatType,[VK_FORMAT_R8G8B8A8_UNORM]:UnsignedByteType,[VK_FORMAT_R8G8B8A8_SRGB]:UnsignedByteType,[VK_FORMAT_R32G32_SFLOAT]:FloatType,[VK_FORMAT_R16G16_SFLOAT]:HalfFloatType,[VK_FORMAT_R8G8_UNORM]:UnsignedByteType,[VK_FORMAT_R8G8_SRGB]:UnsignedByteType,[VK_FORMAT_R32_SFLOAT]:FloatType,[VK_FORMAT_R16_SFLOAT]:HalfFloatType,[VK_FORMAT_R8_SRGB]:UnsignedByteType,[VK_FORMAT_R8_UNORM]:UnsignedByteType,[VK_FORMAT_ASTC_4x4_SFLOAT_BLOCK_EXT]:HalfFloatType,[VK_FORMAT_ASTC_6x6_SRGB_BLOCK]:UnsignedByteType,[VK_FORMAT_ASTC_6x6_UNORM_BLOCK]:UnsignedByteType};async function createRawTexture(e){const{vkFormat:t}=e;if(void 0===FORMAT_MAP[t])throw new Error("THREE.KTX2Loader: Unsupported vkFormat.");let r;e.supercompressionScheme===KHR_SUPERCOMPRESSION_ZSTD&&(_zstd||(_zstd=new Promise((async e=>{const t=new ZSTDDecoder;await t.init(),e(t)}))),r=await _zstd);const o=[];for(let a=0;a<e.levels.length;a++){const s=Math.max(1,e.pixelWidth>>a),i=Math.max(1,e.pixelHeight>>a),n=e.pixelDepth?Math.max(1,e.pixelDepth>>a):0,_=e.levels[a];let T,p;if(e.supercompressionScheme===KHR_SUPERCOMPRESSION_NONE)T=_.levelData;else{if(e.supercompressionScheme!==KHR_SUPERCOMPRESSION_ZSTD)throw new Error("THREE.KTX2Loader: Unsupported supercompressionScheme.");T=r.decode(_.levelData,_.uncompressedByteLength)}p=TYPE_MAP[t]===FloatType?new Float32Array(T.buffer,T.byteOffset,T.byteLength/Float32Array.BYTES_PER_ELEMENT):TYPE_MAP[t]===HalfFloatType?new Uint16Array(T.buffer,T.byteOffset,T.byteLength/Uint16Array.BYTES_PER_ELEMENT):T,o.push({data:p,width:s,height:i,depth:n})}let a;if(UNCOMPRESSED_FORMATS.has(FORMAT_MAP[t]))a=0===e.pixelDepth?new DataTexture(o[0].data,e.pixelWidth,e.pixelHeight):new Data3DTexture(o[0].data,e.pixelWidth,e.pixelHeight,e.pixelDepth);else{if(e.pixelDepth>0)throw new Error("THREE.KTX2Loader: Unsupported pixelDepth.");a=new CompressedTexture(o,e.pixelWidth,e.pixelHeight)}return a.mipmaps=o,a.type=TYPE_MAP[t],a.format=FORMAT_MAP[t],a.colorSpace=parseColorSpace(e),a.needsUpdate=!0,Promise.resolve(a)}function parseColorSpace(e){const t=e.dataFormatDescriptor[0];return t.colorPrimaries===KHR_DF_PRIMARIES_BT709?t.transferFunction===KHR_DF_TRANSFER_SRGB?SRGBColorSpace:LinearSRGBColorSpace:t.colorPrimaries===KHR_DF_PRIMARIES_DISPLAYP3?t.transferFunction===KHR_DF_TRANSFER_SRGB?DisplayP3ColorSpace:LinearDisplayP3ColorSpace:(t.colorPrimaries===KHR_DF_PRIMARIES_UNSPECIFIED||console.warn(`THREE.KTX2Loader: Unsupported color primaries, "${t.colorPrimaries}"`),NoColorSpace)}export{KTX2Loader};
//# sourceMappingURL=/sm/3417d412916db91a84b03ce35587c69f87c09d6559a56dd1907b9279a5e18908.map