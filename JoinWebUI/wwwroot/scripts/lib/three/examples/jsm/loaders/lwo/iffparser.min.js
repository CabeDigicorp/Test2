/**
 * Minified by jsDelivr using Terser v5.19.2.
 * Original file: /npm/three@0.170.0/examples/jsm/loaders/lwo/IFFParser.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{LWO2Parser}from"./LWO2Parser.js";import{LWO3Parser}from"./LWO3Parser.js";class IFFParser{constructor(){this.debugger=new Debugger}parse(e){if(this.reader=new DataViewReader(e),this.tree={materials:{},layers:[],tags:[],textures:[]},this.currentLayer=this.tree,this.currentForm=this.tree,this.parseTopForm(),void 0!==this.tree.format){if("LWO2"===this.tree.format)for(this.parser=new LWO2Parser(this);!this.reader.endOfFile();)this.parser.parseBlock();else if("LWO3"===this.tree.format)for(this.parser=new LWO3Parser(this);!this.reader.endOfFile();)this.parser.parseBlock();return this.debugger.offset=this.reader.offset,this.debugger.closeForms(),this.tree}}parseTopForm(){if(this.debugger.offset=this.reader.offset,"FORM"===this.reader.getIDTag()){var e=this.reader.getUint32();this.debugger.dataOffset=this.reader.offset,this.debugger.length=e;var r=this.reader.getIDTag();("LWO2"===r||"LWO3"===r)&&(this.tree.format=r),this.debugger.node=0,this.debugger.nodeID=r,this.debugger.log()}else console.warn("LWOLoader: Top-level FORM missing.")}parseForm(e){var r=this.reader.getIDTag();switch(r){case"ISEQ":case"ANIM":case"STCC":case"VPVL":case"VPRM":case"NROT":case"WRPW":case"WRPH":case"FUNC":case"FALL":case"OPAC":case"GRAD":case"ENVS":case"VMOP":case"VMBG":case"OMAX":case"STEX":case"CKBG":case"CKEY":case"VMLA":case"VMLB":this.debugger.skipped=!0,this.skipForm(e);break;case"META":case"NNDS":case"NODS":case"NDTA":case"ADAT":case"AOVS":case"BLOK":case"IBGC":case"IOPC":case"IIMG":case"TXTR":this.debugger.length=4,this.debugger.skipped=!0;break;case"IFAL":case"ISCL":case"IPOS":case"IROT":case"IBMP":case"IUTD":case"IVTD":this.parseTextureNodeAttribute(r);break;case"ENVL":this.parseEnvelope(e);break;case"CLIP":"LWO2"===this.tree.format?this.parseForm(e):this.parseClip(e);break;case"STIL":this.parseImage();break;case"XREF":this.reader.skip(8),this.currentForm.referenceTexture={index:this.reader.getUint32(),refName:this.reader.getString()};break;case"IMST":this.parseImageStateForm(e);break;case"SURF":this.parseSurfaceForm(e);break;case"VALU":this.parseValueForm(e);break;case"NTAG":this.parseSubNode(e);break;case"ATTR":case"SATR":this.setupForm("attributes",e);break;case"NCON":this.parseConnections(e);break;case"SSHA":this.parentForm=this.currentForm,this.currentForm=this.currentSurface,this.setupForm("surfaceShader",e);break;case"SSHD":this.setupForm("surfaceShaderData",e);break;case"ENTR":this.parseEntryForm(e);break;case"IMAP":this.parseImageMap(e);break;case"TAMP":this.parseXVAL("amplitude",e);break;case"TMAP":this.setupForm("textureMap",e);break;case"CNTR":this.parseXVAL3("center",e);break;case"SIZE":this.parseXVAL3("scale",e);break;case"ROTA":this.parseXVAL3("rotation",e);break;default:this.parseUnknownForm(r,e)}this.debugger.node=0,this.debugger.nodeID=r,this.debugger.log()}setupForm(e,r){this.currentForm||(this.currentForm=this.currentNode),this.currentFormEnd=this.reader.offset+r,this.parentForm=this.currentForm,this.currentForm[e]?(console.warn("LWOLoader: form already exists on parent: ",e,this.currentForm),this.currentForm=this.currentForm[e]):(this.currentForm[e]={},this.currentForm=this.currentForm[e])}skipForm(e){this.reader.skip(e-4)}parseUnknownForm(e,r){console.warn("LWOLoader: unknown FORM encountered: "+e,r),printBuffer(this.reader.dv.buffer,this.reader.offset,r-4),this.reader.skip(r-4)}parseSurfaceForm(e){this.reader.skip(8);var r=this.reader.getString(),t={attributes:{},connections:{},name:r,inputName:r,nodes:{},source:this.reader.getString()};this.tree.materials[r]=t,this.currentSurface=t,this.parentForm=this.tree.materials,this.currentForm=t,this.currentFormEnd=this.reader.offset+e}parseSurfaceLwo2(e){var r=this.reader.getString(),t={attributes:{},connections:{},name:r,nodes:{},source:this.reader.getString()};this.tree.materials[r]=t,this.currentSurface=t,this.parentForm=this.tree.materials,this.currentForm=t,this.currentFormEnd=this.reader.offset+e}parseSubNode(e){this.reader.skip(8);var r={name:this.reader.getString()};this.currentForm=r,this.currentNode=r,this.currentFormEnd=this.reader.offset+e}parseConnections(e){this.currentFormEnd=this.reader.offset+e,this.parentForm=this.currentForm,this.currentForm=this.currentSurface.connections}parseEntryForm(e){this.reader.skip(8);var r=this.reader.getString();this.currentForm=this.currentNode.attributes,this.setupForm(r,e)}parseValueForm(){this.reader.skip(8);var e=this.reader.getString();"double"===e?this.currentForm.value=this.reader.getUint64():"int"===e?this.currentForm.value=this.reader.getUint32():"vparam"===e?(this.reader.skip(24),this.currentForm.value=this.reader.getFloat64()):"vparam3"===e&&(this.reader.skip(24),this.currentForm.value=this.reader.getFloat64Array(3))}parseImageStateForm(){this.reader.skip(8),this.currentForm.mipMapLevel=this.reader.getFloat32()}parseImageMap(e){this.currentFormEnd=this.reader.offset+e,this.parentForm=this.currentForm,this.currentForm.maps||(this.currentForm.maps=[]);var r={};this.currentForm.maps.push(r),this.currentForm=r,this.reader.skip(10)}parseTextureNodeAttribute(e){switch(this.reader.skip(28),this.reader.skip(20),e){case"ISCL":this.currentNode.scale=this.reader.getFloat32Array(3);break;case"IPOS":this.currentNode.position=this.reader.getFloat32Array(3);break;case"IROT":this.currentNode.rotation=this.reader.getFloat32Array(3);break;case"IFAL":this.currentNode.falloff=this.reader.getFloat32Array(3);break;case"IBMP":this.currentNode.amplitude=this.reader.getFloat32();break;case"IUTD":this.currentNode.uTiles=this.reader.getFloat32();break;case"IVTD":this.currentNode.vTiles=this.reader.getFloat32()}this.reader.skip(2)}parseEnvelope(e){this.reader.skip(e-4)}parseClip(e){if("FORM"===this.reader.getIDTag())return this.reader.skip(16),void(this.currentNode.fileName=this.reader.getString());this.reader.setOffset(this.reader.offset-4),this.currentFormEnd=this.reader.offset+e,this.parentForm=this.currentForm,this.reader.skip(8);var r={index:this.reader.getUint32()};this.tree.textures.push(r),this.currentForm=r}parseClipLwo2(e){for(var r={index:this.reader.getUint32(),fileName:""};;){var t=this.reader.getIDTag(),s=this.reader.getUint16();if("STIL"===t){r.fileName=this.reader.getString();break}if(s>=e)break}this.tree.textures.push(r),this.currentForm=r}parseImage(){this.reader.skip(8),this.currentForm.fileName=this.reader.getString()}parseXVAL(e,r){var t=this.reader.offset+r-4;this.reader.skip(8),this.currentForm[e]=this.reader.getFloat32(),this.reader.setOffset(t)}parseXVAL3(e,r){var t=this.reader.offset+r-4;this.reader.skip(8),this.currentForm[e]={x:this.reader.getFloat32(),y:this.reader.getFloat32(),z:this.reader.getFloat32()},this.reader.setOffset(t)}parseObjectTag(){this.tree.objectTags||(this.tree.objectTags={}),this.tree.objectTags[this.reader.getIDTag()]={tagString:this.reader.getString()}}parseLayer(e){var r=this.reader.getUint16(),t=this.reader.getUint16(),s=this.reader.getFloat32Array(3),a={number:r,flags:t,pivot:[-s[0],s[1],s[2]],name:this.reader.getString()};this.tree.layers.push(a),this.currentLayer=a;var i=16+stringOffset(this.currentLayer.name);this.currentLayer.parent=i<e?this.reader.getUint16():-1}parsePoints(e){this.currentPoints=[];for(var r=0;r<e/4;r+=3)this.currentPoints.push(-this.reader.getFloat32(),this.reader.getFloat32(),this.reader.getFloat32())}parseVertexMapping(e,r){var t=this.reader.offset+e,s=this.reader.getString();if(this.reader.offset!==t){this.reader.setOffset(this.reader.offset-stringOffset(s));var a=this.reader.getIDTag();this.reader.getUint16();var i=this.reader.getString(),h=e-6-stringOffset(i);switch(a){case"TXUV":this.parseUVMapping(i,t,r);break;case"MORF":case"SPOT":this.parseMorphTargets(i,t,a);break;case"APSL":case"NORM":case"WGHT":case"MNVW":case"PICK":case"RGB ":case"RGBA":this.reader.skip(h);break;default:console.warn("LWOLoader: unknown vertex map type: "+a),this.reader.skip(h)}}else this.currentForm.UVChannel=s}parseUVMapping(e,r,t){for(var s=[],a=[],i=[];this.reader.offset<r;)s.push(this.reader.getVariableLengthIndex()),t&&a.push(this.reader.getVariableLengthIndex()),i.push(this.reader.getFloat32(),this.reader.getFloat32());t?(this.currentLayer.discontinuousUVs||(this.currentLayer.discontinuousUVs={}),this.currentLayer.discontinuousUVs[e]={uvIndices:s,polyIndices:a,uvs:i}):(this.currentLayer.uvs||(this.currentLayer.uvs={}),this.currentLayer.uvs[e]={uvIndices:s,uvs:i})}parseMorphTargets(e,r,t){var s=[],a=[];for(t="MORF"===t?"relative":"absolute";this.reader.offset<r;)s.push(this.reader.getVariableLengthIndex()),a.push(this.reader.getFloat32(),this.reader.getFloat32(),-this.reader.getFloat32());this.currentLayer.morphTargets||(this.currentLayer.morphTargets={}),this.currentLayer.morphTargets[e]={indices:s,points:a,type:t}}parsePolygonList(e){for(var r=this.reader.offset+e,t=this.reader.getIDTag(),s=[],a=[];this.reader.offset<r;){var i=this.reader.getUint16();i&=1023,a.push(i);for(var h=0;h<i;h++)s.push(this.reader.getVariableLengthIndex())}var n={type:t,vertexIndices:s,polygonDimensions:a,points:this.currentPoints};1===a[0]?n.type="points":2===a[0]&&(n.type="lines"),this.currentLayer.geometry=n}parseTagStrings(e){this.tree.tags=this.reader.getStringArray(e)}parsePolygonTagMapping(e){var r=this.reader.offset+e;"SURF"===this.reader.getIDTag()?this.parseMaterialIndices(r):this.reader.skip(e-4)}parseMaterialIndices(e){for(this.currentLayer.geometry.materialIndices=[];this.reader.offset<e;){var r=this.reader.getVariableLengthIndex(),t=this.reader.getUint16();this.currentLayer.geometry.materialIndices.push(r,t)}}parseUnknownCHUNK(e,r){console.warn("LWOLoader: unknown chunk type: "+e+" length: "+r);var t=this.reader.getString(r);this.currentForm[e]=t}}class DataViewReader{constructor(e){this.dv=new DataView(e),this.offset=0,this._textDecoder=new TextDecoder,this._bytes=new Uint8Array(e)}size(){return this.dv.buffer.byteLength}setOffset(e){e>0&&e<this.dv.buffer.byteLength?this.offset=e:console.error("LWOLoader: invalid buffer offset")}endOfFile(){return this.offset>=this.size()}skip(e){this.offset+=e}getUint8(){var e=this.dv.getUint8(this.offset);return this.offset+=1,e}getUint16(){var e=this.dv.getUint16(this.offset);return this.offset+=2,e}getInt32(){var e=this.dv.getInt32(this.offset,!1);return this.offset+=4,e}getUint32(){var e=this.dv.getUint32(this.offset,!1);return this.offset+=4,e}getUint64(){return 4294967296*this.getUint32()+this.getUint32()}getFloat32(){var e=this.dv.getFloat32(this.offset,!1);return this.offset+=4,e}getFloat32Array(e){for(var r=[],t=0;t<e;t++)r.push(this.getFloat32());return r}getFloat64(){var e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}getFloat64Array(e){for(var r=[],t=0;t<e;t++)r.push(this.getFloat64());return r}getVariableLengthIndex(){var e=this.getUint8();return 255===e?65536*this.getUint8()+256*this.getUint8()+this.getUint8():256*e+this.getUint8()}getIDTag(){return this.getString(4)}getString(e){if(0===e)return;const r=this.offset;let t,s;return e?(s=e,t=this._textDecoder.decode(new Uint8Array(this.dv.buffer,r,e))):(s=this._bytes.indexOf(0,r)-r,t=this._textDecoder.decode(new Uint8Array(this.dv.buffer,r,s)),s++,s+=s%2),this.skip(s),t}getStringArray(e){var r=this.getString(e);return(r=r.split("\0")).filter(Boolean)}}class Debugger{constructor(){this.active=!1,this.depth=0,this.formList=[]}enable(){this.active=!0}log(){if(this.active){var e;switch(this.node){case 0:e="FORM";break;case 1:e="CHK";break;case 2:e="S-CHK"}console.log("| ".repeat(this.depth)+e,this.nodeID,`( ${this.offset} ) -> ( ${this.dataOffset+this.length} )`,0==this.node?" {":"",this.skipped?"SKIPPED":"",0==this.node&&this.skipped?"}":""),0!=this.node||this.skipped||(this.depth+=1,this.formList.push(this.dataOffset+this.length)),this.skipped=!1}}closeForms(){if(this.active)for(var e=this.formList.length-1;e>=0;e--)this.offset>=this.formList[e]&&(this.depth-=1,console.log("| ".repeat(this.depth)+"}"),this.formList.splice(-1,1))}}function isEven(e){return e%2}function stringOffset(e){return e.length+1+(isEven(e.length+1)?1:0)}function printBuffer(e,r,t){console.log((new TextDecoder).decode(new Uint8Array(e,r,t)))}export{IFFParser};
//# sourceMappingURL=/sm/9d874ae4333d7e9db3af60c901f73de8526d5ca5d9aa789886f95a0d53b9a36f.map